<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PuppyPad Shipping Auditor</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                min-height: 100vh;
                padding: 2rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .container { max-width: 1400px; margin: 0 auto; width: 100%; }
            .card {
                background: #ffffff;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 2rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            .header {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
                margin-bottom: 2rem;
            }
            .icon {
                width: 5rem;
                height: 5rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .icon img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }
            h1 {
                font-size: 2rem;
                color: #1e293b;
                font-weight: 700;
                text-align: center;
            }
            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
                margin-bottom: 1.5rem;
            }
            .form-group { margin-bottom: 1.5rem; }
            .form-group-inline {
                display: grid;
                grid-template-columns: 280px 1fr;
                gap: 1rem;
                align-items: flex-end;
            }
            label {
                display: block;
                font-weight: 600;
                color: #475569;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
            }
            input[type="number"],
            input[type="text"] {
                padding: 0.875rem 1rem;
                background: #ffffff;
                border: 1px solid #cbd5e1;
                border-radius: 8px;
                font-size: 1rem;
                color: #1e293b;
                transition: all 0.2s;
                font-family: 'Inter', sans-serif;
                width: 100%;
            }
            input[type="number"]::placeholder,
            input[type="text"]::placeholder {
                color: #94a3b8;
            }
            input:focus {
                outline: none;
                border-color: #fbbf24;
                box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
            }
            .file-upload {
                border: 2px dashed #cbd5e1;
                border-radius: 8px;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                background: #f8fafc;
                color: #64748b;
            }
            .file-upload:hover {
                border-color: #fbbf24;
                background: #fffbeb;
            }
            .file-upload.has-file {
                border-color: #fbbf24;
                background: #fffbeb;
            }
            .file-name {
                color: #f59e0b;
                font-weight: 600;
            }
            button {
                padding: 0.875rem 2rem;
                background: #2d3748;
                color: #ffffff;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
            }
            button:hover:not(:disabled) {
                background: #1a202c;
                transform: translateY(-1px);
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .progress-container {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 1.5rem;
                margin: 1rem 0;
            }
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .progress-text {
                font-weight: 600;
                color: #f59e0b;
                font-size: 1rem;
            }
            .progress-percentage {
                font-weight: 700;
                color: #f59e0b;
                font-size: 1.5rem;
            }
            .progress-bar-container {
                width: 100%;
                height: 8px;
                background: #e2e8f0;
                border-radius: 999px;
                overflow: hidden;
                margin-bottom: 0.75rem;
            }
            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
                border-radius: 999px;
                transition: width 0.3s ease;
                width: 0%;
            }
            .progress-status {
                color: #64748b;
                font-size: 0.875rem;
            }
            .status-log {
                background: #ffffff;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 1rem;
                max-height: 150px;
                overflow-y: auto;
                font-size: 0.813rem;
                font-family: 'Courier New', monospace;
                margin-top: 1rem;
            }
            .status-line {
                margin-bottom: 0.25rem;
                color: #64748b;
            }
            .status-line.success {
                color: #10b981;
            }
            .status-line.error {
                color: #ef4444;
            }
            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }
            .result-card {
                background: #ffffff;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 1.5rem;
                transition: all 0.2s;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            .result-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            .result-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .result-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
            }
            .result-amount {
                font-size: 1.75rem;
                font-weight: 800;
                margin: 0.5rem 0;
            }
            .download-btn {
                padding: 0.75rem 1rem;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
                width: 100%;
                font-weight: 600;
                font-size: 0.875rem;
                background: #2d3748 !important;
                color: #ffffff !important;
                border: none;
            }
            .download-btn:hover {
                background: #1a202c !important;
                transform: translateY(-1px);
            }
            .input-toggle {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 0.75rem;
            }
            .toggle-btn {
                padding: 0.5rem 1rem;
                background: #e2e8f0;
                border: none;
                border-radius: 6px;
                color: #475569;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.813rem;
                flex: 1;
            }
            .toggle-btn.active {
                background: #2d3748;
                color: #ffffff;
            }
            .input-option {
                display: none;
            }
            .input-option.active {
                display: block;
            }
            .error-box {
                background: #fef2f2;
                border: 1px solid #fecaca;
                color: #991b1b;
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
            }
            .hidden { display: none; }
            table {
                border-collapse: collapse;
                width: 100%;
                background: #ffffff;
            }
            th, td {
                padding: 0.875rem;
                text-align: left;
            }
            th {
                font-weight: 600;
                color: #475569;
                background: #f8fafc;
                border-bottom: 2px solid #e2e8f0;
                font-size: 0.8125rem;
            }
            td {
                color: #334155;
                border-bottom: 1px solid #f1f5f9;
                font-size: 0.875rem;
            }
            tr:hover {
                background: #f8fafc;
            }
            .tab-btn {
                padding: 0.5rem 1rem;
                background: #e2e8f0;
                border: none;
                border-radius: 6px;
                color: #475569;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.875rem;
            }
            .tab-btn:hover {
                background: #cbd5e1;
            }
            .tab-btn.active {
                background: #2d3748;
                color: #ffffff;
            }
            .accordion {
                background: #ffffff;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                overflow: hidden;
                margin-bottom: 1.5rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            .accordion-header {
                padding: 1.5rem;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #fef2f2;
                transition: all 0.2s;
            }
            .accordion-header:hover {
                background: #fee2e2;
            }
            .accordion-title {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-size: 1.125rem;
                font-weight: 700;
                color: #991b1b;
            }
            .accordion-chevron {
                font-size: 1.5rem;
                transition: transform 0.3s ease;
                color: #f59e0b;
            }
            .accordion-chevron.open {
                transform: rotate(180deg);
            }
            .accordion-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }
            .accordion-content.open {
                max-height: 5000px;
                padding: 1.5rem;
            }
            .missing-carriers-table {
                background: #fffbeb;
                border: 1px solid #fde68a;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }
            .table-container {
                max-height: 500px;
                overflow-y: auto;
                border-radius: 8px;
                background: #ffffff;
                border: 1px solid #e2e8f0;
            }
            .table-container::-webkit-scrollbar {
                width: 10px;
            }
            .table-container::-webkit-scrollbar-track {
                background: #f1f5f9;
            }
            .table-container::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 5px;
            }
            .table-container::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
            h3 {
                color: #1e293b;
                font-weight: 600;
                font-size: 1rem;
            }
            h2 {
                color: #1e293b;
                font-weight: 700;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <div class="header">
                    <div class="icon">
                        <img src="https://cdn.shopify.com/s/files/1/0433/0510/7612/files/navyblue-logo.svg?v=1754231041" alt="PuppyPad Logo">
                    </div>
                    <h1>PuppyPad Shipping Auditor</h1>
                </div>

                <div class="form-row">
                    <!-- Shipping Line Charges -->
                    <div class="form-group">
                        <label>üìä Shipping Line Charges</label>
                        <div class="input-toggle">
                            <button class="toggle-btn" onclick="toggleInputType('rates', 'upload')">Upload File</button>
                            <button class="toggle-btn active" onclick="toggleInputType('rates', 'link')">Google Sheet Link</button>
                        </div>
                        <div class="input-option" id="rates-upload">
                            <div class="file-upload" id="ratesUpload" onclick="document.getElementById('ratesFile').click()">
                                <span id="ratesLabel">üìÑ Click to upload Excel file</span>
                            </div>
                            <input type="file" id="ratesFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('rates')" />
                        </div>
                        <div class="input-option active" id="rates-link">
                            <input type="text" id="ratesLink" placeholder="Paste Google Sheet link here" onchange="handleLinkInput('rates')">
                        </div>
                    </div>

                    <!-- Mrek Orders -->
                    <div class="form-group">
                        <label>üì¶ Mrek Orders</label>
                        <div class="input-toggle">
                            <button class="toggle-btn" onclick="toggleInputType('orders', 'upload')">Upload File</button>
                            <button class="toggle-btn active" onclick="toggleInputType('orders', 'link')">Google Sheet Link</button>
                        </div>
                        <div class="input-option" id="orders-upload">
                            <div class="file-upload" id="ordersUpload" onclick="document.getElementById('ordersFile').click()">
                                <span id="ordersLabel">üìÑ Click to upload Excel file</span>
                            </div>
                            <input type="file" id="ordersFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('orders')" />
                        </div>
                        <div class="input-option active" id="orders-link">
                            <input type="text" id="ordersLink" placeholder="Paste Google Sheet link here" onchange="handleLinkInput('orders')">
                        </div>
                    </div>
                </div>

                <!-- Remote Reference -->
                <div class="form-group">
                    <label>üìç Remote Address Reference (Optional)</label>
                    <div class="input-toggle">
                        <button class="toggle-btn" onclick="toggleInputType('remote', 'upload')">Upload File</button>
                        <button class="toggle-btn active" onclick="toggleInputType('remote', 'link')">Google Sheet Link</button>
                    </div>
                    <div class="input-option" id="remote-upload">
                        <div class="file-upload" id="remoteUpload" onclick="document.getElementById('remoteFile').click()">
                            <span id="remoteLabel">üìÑ Click to upload Remote ZIP list</span>
                        </div>
                        <input type="file" id="remoteFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('remote')" />
                    </div>
                    <div class="input-option active" id="remote-link">
                        <input type="text" id="remoteLink" placeholder="Paste Google Sheet link here" onchange="handleLinkInput('remote')">
                    </div>
                </div>

                <div id="errorBox" class="error-box hidden"></div>

                <div id="progressContainer" class="progress-container hidden">
                    <div class="progress-header">
                        <div class="progress-text" id="progressText">Initializing...</div>
                        <div class="progress-percentage" id="progressPercent">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-status" id="progressStatus">Preparing...</div>
                    <div class="status-log" id="statusLog"></div>
                </div>

                <div class="form-group-inline">
                    <div class="form-group" style="margin: 0;">
                        <label>Exchange Rate (CNY to USD)</label>
                        <input type="number" id="exchangeRate" value="6.9" step="0.01" />
                    </div>
                    <button id="analyzeBtn" onclick="analyzeOrders()">üìä Analyze All Orders</button>
                </div>
            </div>

            <div id="resultsContainer" class="hidden"></div>
        </div>

        <script>
            // GLOBAL STATE
            let ratesData = null, ordersData = null, remoteRefData = null;
            let remoteRules = [];
            let resultsData = null;

            function handleFileSelect(type) {
                const input = document.getElementById(type + "File");
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });
                    if (type === "rates") {
                        ratesData = jsonData;
                        document.getElementById("ratesUpload").classList.add("has-file");
                        document.getElementById("ratesLabel").innerHTML = `<span class="file-name">${file.name} (${jsonData.length} rows)</span>`;
                    } else if (type === "orders") {
                        ordersData = jsonData;
                        document.getElementById("ordersUpload").classList.add("has-file");
                        document.getElementById("ordersLabel").innerHTML = `<span class="file-name">${file.name} (${jsonData.length} rows)</span>`;
                    } else if (type === "remote") {
                        remoteRefData = jsonData;
                        document.getElementById("remoteUpload").classList.add("has-file");
                        document.getElementById("remoteLabel").innerHTML = `<span class="file-name">${file.name} (${jsonData.length} rows)</span>`;
                    }
                };
                reader.readAsArrayBuffer(file);
                saveToURL();
            }

            function toggleInputType(type, inputType) {
                const uploadOption = document.getElementById(`${type}-upload`);
                const linkOption = document.getElementById(`${type}-link`);
                const buttonsContainer = uploadOption.parentElement.querySelector('.input-toggle');
                const buttons = buttonsContainer.querySelectorAll('.toggle-btn');

                buttons.forEach(btn => btn.classList.remove('active'));
                buttons.forEach(btn => {
                    if ((inputType === 'upload' && btn.textContent.includes('Upload')) ||
                        (inputType === 'link' && btn.textContent.includes('Link'))) {
                        btn.classList.add('active');
                    }
                });

                uploadOption.classList.remove('active');
                linkOption.classList.remove('active');
                document.getElementById(`${type}-${inputType}`).classList.add('active');
            }

            async function handleLinkInput(type) {
                const link = document.getElementById(type + "Link").value;
                if (!link) return;

                try {
                    const match = link.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (!match) {
                        showError("Invalid Google Sheets URL");
                        return;
                    }

                    const sheetId = match[1];
                    const exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;

                    const response = await fetch(exportUrl);
                    const arrayBuffer = await response.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });

                    if (type === "rates") {
                        ratesData = jsonData;
                        document.getElementById("ratesLabel").innerHTML = `<span class="file-name">‚úÖ Loaded from Google Sheets (${jsonData.length} rows)</span>`;
                    } else if (type === "orders") {
                        ordersData = jsonData;
                        document.getElementById("ordersLabel").innerHTML = `<span class="file-name">‚úÖ Loaded from Google Sheets (${jsonData.length} rows)</span>`;
                    } else if (type === "remote") {
                        remoteRefData = jsonData;
                        document.getElementById("remoteLabel").innerHTML = `<span class="file-name">‚úÖ Loaded from Google Sheets (${jsonData.length} rows)</span>`;
                    }

                    saveToURL();
                } catch (error) {
                    showError("Failed to load Google Sheet. Make sure it's publicly accessible.");
                }
            }

            function saveToURL() {
                const exchangeRate = document.getElementById('exchangeRate').value;
                const url = new URL(window.location);
                url.searchParams.set('exchangeRate', exchangeRate);
                window.history.pushState({}, '', url);
            }

            function loadFromURL() {
                const url = new URL(window.location);
                const exchangeRate = url.searchParams.get('exchangeRate');
                if (exchangeRate) {
                    document.getElementById('exchangeRate').value = exchangeRate;
                }
            }

            function updateProgress(percent, text, status) {
                document.getElementById("progressContainer").classList.remove("hidden");
                document.getElementById("progressBar").style.width = percent + "%";
                document.getElementById("progressPercent").textContent = Math.round(percent) + "%";
                document.getElementById("progressText").textContent = text;
                if (status) document.getElementById("progressStatus").textContent = status;
            }

            function addStatusLog(message, type = "info") {
                const log = document.getElementById("statusLog");
                const line = document.createElement("div");
                line.className = `status-line ${type}`;
                line.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                log.appendChild(line);
                log.scrollTop = log.scrollHeight;
            }

            function showError(message) {
                document.getElementById("errorBox").textContent = message;
                document.getElementById("errorBox").classList.remove("hidden");
            }

            async function callOpenAI(prompt) {
                const response = await fetch("/api/openai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            { role: "system", content: "Return ONLY valid JSON. No markdown, no explanation." },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0,
                        max_tokens: 1000,
                    }),
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API failed: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                if (!data.choices?.[0]?.message?.content) throw new Error("Invalid API response");
                return data.choices[0].message.content;
            }

            function extractJSON(text) {
                let cleaned = text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                const match = cleaned.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                if (match) cleaned = match[0];
                return JSON.parse(cleaned);
            }

            function parseWeightRange(rangeStr) {
                if (!rangeStr || typeof rangeStr !== 'string') return null;
                const match = rangeStr.match(/([\d.]+)[Ôºú<].*?[‚â§<=]([\d.]+)/);
                if (!match) return null;
                return {
                    minWeight: parseFloat(match[1]),
                    maxWeight: parseFloat(match[2])
                };
            }

            function containsChinese(text) {
                return /[\u4e00-\u9fa5]/.test(text);
            }

            async function translateChinese(text) {
                if (!containsChinese(text)) return text;
                try {
                    const prompt = `Translate this Chinese shipping carrier/method name to English. Return ONLY the English translation, nothing else: "${text}"`;
                    const response = await callOpenAI(prompt);
                    return response.trim().replace(/["""]/g, '');
                } catch (error) {
                    console.error('Translation error:', error);
                    return text;
                }
            }

            function normalizeShippingLine(text) {
                return text ? text.toLowerCase().replace(/^[^-]+-/, '').replace(/\s+/g, '').replace(/[()ÔºàÔºâ]/g, '') : "";
            }

            function matchShippingLine(orderLine, rateLine, orderLineEn = '', rateLineEn = '') {
                const o = normalizeShippingLine(orderLine);
                const r = normalizeShippingLine(rateLine);
                const oEn = normalizeShippingLine(orderLineEn);
                const rEn = normalizeShippingLine(rateLineEn);

                return o.includes(r) || r.includes(o) ||
                    (oEn && rEn && (oEn.includes(rEn) || rEn.includes(oEn))) ||
                    (oEn && (oEn.includes(r) || r.includes(oEn))) ||
                    (rEn && (o.includes(rEn) || rEn.includes(o)));
            }

            function parseRemoteRef(remoteData) {
                remoteRules = [];
                if (!remoteData) return;

                for (let i = 1; i < remoteData.length; i++) {
                    const row = remoteData[i];
                    if (!row) continue;

                    const carrier = (row[0] || '').toString().trim().toLowerCase();
                    const country = (row[1] || '').toString().trim().toUpperCase();
                    const state   = (row[2] || '').toString().trim().toUpperCase() || null;
                    const zipStart = row[3] !== undefined && row[3] !== '' ? String(row[3]).padStart(5, '0') : null;
                    const zipEnd   = row[4] !== undefined && row[4] !== '' ? String(row[4]).padStart(5, '0') : null;

                    if (!country && !zipStart && !zipEnd) continue;

                    remoteRules.push({ carrier, country, state, zipStart, zipEnd });
                }
            }

            function inferCarrierKey(shippingLine) {
                const lower = (shippingLine || '').toLowerCase();
                if (lower.includes('yuntu') || lower.includes('yunexpress') || lower.includes('‰∫ëÈÄî')) return 'yuntu';
                if (lower.includes('yanwen') || lower.includes('ÁáïÊñá')) return 'yanwen';
                return '';
            }

            function isRemoteAddress(order) {
                if (!remoteRules.length) return false;
                const country = (order.country || '').toUpperCase();
                const state   = (order.state || '').toUpperCase();
                const zip     = (order.postCode || '').toString().padStart(5, '0');
                const carrierKey = inferCarrierKey(order.shippingLine);

                return remoteRules.some(rule => {
                    if (rule.carrier && carrierKey && !carrierKey.includes(rule.carrier)) return false;
                    if (rule.country && rule.country !== country) return false;
                    if (rule.state && rule.state !== state) return false;
                    if (rule.zipStart && rule.zipEnd && zip >= rule.zipStart && zip <= rule.zipEnd) return true;
                    return false;
                });
            }

            async function analyzeOrders() {
                document.getElementById("analyzeBtn").disabled = true;
                document.getElementById("errorBox").classList.add("hidden");
                document.getElementById("statusLog").innerHTML = "";
                document.getElementById("resultsContainer").innerHTML = "";
                document.getElementById("resultsContainer").classList.add("hidden");

                try {
                    if (!ratesData || !ordersData) throw new Error("Upload both files");
                    const exchangeRate = parseFloat(document.getElementById("exchangeRate").value);
                    if (isNaN(exchangeRate) || exchangeRate <= 0) throw new Error("Invalid exchange rate");

                    if (remoteRefData) {
                        parseRemoteRef(remoteRefData);
                        addStatusLog(`Loaded ${remoteRules.length} remote rules`, "success");
                    } else {
                        addStatusLog("No remote reference file loaded ‚Äì remote address checks limited.", "info");
                    }

                    updateProgress(5, "‚ö° Parsing Rate Sheet", "Using JavaScript...");
                    addStatusLog(`Rate sheet: ${ratesData.length} rows, Orders: ${ordersData.length} rows`);

                    let shippingLineName = ratesData[1][0] ? String(ratesData[1][0]).trim() : "";
                    addStatusLog(`Found shipping line: ${shippingLineName}`);

                    let shippingLineNameEn = shippingLineName;
                    if (containsChinese(shippingLineName)) {
                        updateProgress(10, "üåê Translating Chinese", "Translating shipping carrier name...");
                        addStatusLog(`Detected Chinese in shipping line name, translating...`);
                        shippingLineNameEn = await translateChinese(shippingLineName);
                        addStatusLog(`Translation: "${shippingLineName}" ‚Üí "${shippingLineNameEn}"`, "success");
                    }

                    const ratesByCountry = {};
                    const countryMapping = {};
                    let currentCountry = null;

                    for (let i = 2; i < ratesData.length; i++) {
                        const row = ratesData[i];
                        if (!row || row.length < 7) continue;

                        if (row[0] && typeof row[0] === 'string' && row[0].trim()) {
                            currentCountry = row[0].trim();
                            const normalized = currentCountry.toUpperCase();
                            ratesByCountry[normalized] = [];
                            countryMapping[normalized] = currentCountry;
                        }

                        const weightRange = row[3]; // Weight (KG)
                        const costPerKg   = row[6]; // Shipping Cost (RMB/KG)
                        const regFee      = row[7]; // Registration Fee (RMB/shipment)

                        if (currentCountry && weightRange && costPerKg) {
                            const weights = parseWeightRange(weightRange);
                            if (weights) {
                                const normalized = currentCountry.toUpperCase();
                                ratesByCountry[normalized].push({
                                    minWeight: weights.minWeight,
                                    maxWeight: weights.maxWeight,
                                    costPerKg: parseFloat(costPerKg),
                                    regFee: parseFloat(regFee) || 0,
                                    type: 'yuntu',
                                    details: `${weights.minWeight}-${weights.maxWeight}kg @ ¬•${costPerKg}/kg + ¬•${regFee || 0} reg`
                                });
                            }
                        }
                    }

                    const totalCountries = Object.keys(ratesByCountry).length;
                    const totalBrackets = Object.values(ratesByCountry).reduce((s, b) => s + b.length, 0);

                    updateProgress(20, "‚úÖ Rate Sheet Parsed", `${totalCountries} countries, ${totalBrackets} brackets`);
                    addStatusLog(`‚úÖ Parsed ${totalCountries} countries with ${totalBrackets} rate brackets`, "success");
                    if (totalBrackets === 0) throw new Error("No rate brackets found in rate sheet");

                    updateProgress(25, "ü§ñ AI Detecting Columns", "One quick AI call...");
                    addStatusLog("ü§ñ Using AI to detect order columns...");

                    const orderSample = ordersData.slice(0, 3).map(r => r.join("|")).join("\n");
                    const colPrompt = `Identify column indices (0-based) in this data:
${orderSample}

Return ONLY JSON with these keys (use -1 if not present):
{
  "orderIdCol":0,
  "countryCol":1,
  "weightCol":2,
  "cnyCostCol":3,
  "usdCostCol":4,
  "shippingLineCol":5,
  "stateCol":6,
  "postCodeCol":7,
  "handlingUsdCol":8,
  "handlingCnyCol":9,
  "remoteUsdCol":10,
  "remoteCnyCol":11
}`;

                    const colResponse = await callOpenAI(colPrompt);
                    const colMap = extractJSON(colResponse);

                    updateProgress(40, "‚úÖ Columns Detected", "AI analysis complete");
                    addStatusLog(`‚úÖ Detected: Order=${colMap.orderIdCol}, Country=${colMap.countryCol}, Weight=${colMap.weightCol}`, "success");

                    updateProgress(45, "üìä Parsing Orders", "Extracting all order data...");
                    addStatusLog("üìä Parsing orders with JavaScript...");

                    const allOrders = [];
                    for (let i = 1; i < ordersData.length; i++) {
                        const row = ordersData[i];
                        if (!row || row[colMap.orderIdCol] === undefined || row[colMap.orderIdCol] === "") continue;

                        const getVal = (idx) => (idx !== undefined && idx !== null && idx >= 0) ? row[idx] : "";

                        const orderId       = String(getVal(colMap.orderIdCol) || "").trim();
                        const country       = String(getVal(colMap.countryCol) || "").trim();
                        const totalWeight   = parseFloat(getVal(colMap.weightCol)) || 0;
                        const chargedCNY    = parseFloat(getVal(colMap.cnyCostCol)) || 0;
                        const chargedUSD    = parseFloat(getVal(colMap.usdCostCol)) || 0;
                        const shippingLine  = String(getVal(colMap.shippingLineCol) || "").trim();
                        const state         = String(getVal(colMap.stateCol) || "").trim();
                        const postCode      = String(getVal(colMap.postCodeCol) || "").trim();

                        const handlingUSD   = parseFloat(getVal(colMap.handlingUsdCol)) || 0;
                        const handlingCNY   = parseFloat(getVal(colMap.handlingCnyCol)) || 0;
                        const remoteUSD     = parseFloat(getVal(colMap.remoteUsdCol)) || 0;
                        const remoteCNY     = parseFloat(getVal(colMap.remoteCnyCol)) || 0;

                        allOrders.push({
                            orderId,
                            country,
                            totalWeight,
                            chargedCNY,
                            chargedUSD,
                            shippingLine,
                            state,
                            postCode,
                            handlingUSD,
                            handlingCNY,
                            remoteUSD,
                            remoteCNY
                        });
                    }

                    updateProgress(50, "‚úÖ Orders Parsed", `${allOrders.length} orders ready`);
                    addStatusLog(`‚úÖ Parsed ${allOrders.length} valid orders from ${ordersData.length} rows`, "success");

                    updateProgress(55, "‚ö° Matching Orders", "Processing...");
                    addStatusLog("‚ö° Matching orders to rates...");

                    const results = { overcharge: [], undercharge: [], accurate: [], invalid: [], missingCarriers: [], remoteOrders: [] };
                    const total = allOrders.length;
                    const missingCarrierMap = new Map();
                    const translationCache = new Map();

                    for (let i = 0; i < total; i++) {
                        const order = allOrders[i];

                        if (i % 100 === 0) {
                            const percent = 55 + (i / total) * 40;
                            updateProgress(percent, "‚ö° Processing", `${i}/${total} orders (${Math.round(i/total*100)}%)`);
                        }

                        let orderShippingLineEn = order.shippingLine;
                        if (containsChinese(order.shippingLine)) {
                            if (translationCache.has(order.shippingLine)) {
                                orderShippingLineEn = translationCache.get(order.shippingLine);
                            } else {
                                orderShippingLineEn = await translateChinese(order.shippingLine);
                                translationCache.set(order.shippingLine, orderShippingLineEn);
                                addStatusLog(`Translated order carrier: "${order.shippingLine}" ‚Üí "${orderShippingLineEn}"`);
                            }
                        }

                        if (!matchShippingLine(order.shippingLine, shippingLineName, orderShippingLineEn, shippingLineNameEn)) {
                            const carrierKey = containsChinese(order.shippingLine)
                                ? `${order.shippingLine} (${orderShippingLineEn})`
                                : order.shippingLine;

                            if (!missingCarrierMap.has(carrierKey)) {
                                missingCarrierMap.set(carrierKey, []);
                            }
                            missingCarrierMap.get(carrierKey).push(order.orderId);

                            const rateCarrierDisplay = containsChinese(shippingLineName)
                                ? `${shippingLineName} (${shippingLineNameEn})`
                                : shippingLineName;

                            results.invalid.push({
                                ...order,
                                reason: `Shipping carrier/method mismatch`,
                                details: `Order uses shipping carrier "${carrierKey}" which doesn't match the rate sheet carrier "${rateCarrierDisplay}".`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A"
                            });
                            continue;
                        }

                        const normalizedCountry = order.country.toUpperCase();
                        const countryRates = ratesByCountry[normalizedCountry];
                        if (!countryRates || countryRates.length === 0) {
                            let errorReason, errorDetails;
                            if (!order.country || order.country.trim() === "") {
                                errorReason = "Missing country information";
                                errorDetails = "No country specified for this order.";
                            } else {
                                errorReason = `Country "${order.country}" not found in rate sheet`;
                                errorDetails = `Destination "${order.country}" has no rates in this sheet.`;
                            }
                            results.invalid.push({
                                ...order,
                                reason: errorReason,
                                details: errorDetails,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A"
                            });
                            continue;
                        }

                        const bracket = countryRates.find(b => order.totalWeight > b.minWeight && order.totalWeight <= b.maxWeight);
                        if (!bracket) {
                            const availableRanges = countryRates.map(b => `${b.minWeight}-${b.maxWeight}kg`).join(', ');
                            results.invalid.push({
                                ...order,
                                reason: `Weight ${order.totalWeight}kg out of range for ${order.country}`,
                                details: `No rate for weight ${order.totalWeight}kg. Ranges: ${availableRanges}`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A"
                            });
                            continue;
                        }

                        const expectedCNY = (order.totalWeight * bracket.costPerKg) + bracket.regFee;
                        const expectedUSD = expectedCNY / exchangeRate;
                        const difference = order.chargedUSD - expectedUSD;

                        const addressIsRemote = isRemoteAddress(order);
                        const remoteChargeUSD = order.remoteUSD || (order.remoteCNY ? (order.remoteCNY / exchangeRate) : 0);
                        const handlingUSD = order.handlingUSD || (order.handlingCNY ? (order.handlingCNY / exchangeRate) : 0);
                        const totalChargedUSD = order.chargedUSD + handlingUSD + remoteChargeUSD;

                        let remoteStatus = "Not remote";
                        if (addressIsRemote && remoteChargeUSD > 0) {
                            remoteStatus = "‚úÖ Remote address & surcharge charged";
                        } else if (addressIsRemote && remoteChargeUSD === 0) {
                            remoteStatus = "‚ö† Remote address but NO surcharge charged";
                        } else if (!addressIsRemote && remoteChargeUSD > 0) {
                            remoteStatus = "‚ùå Surcharge charged but address not remote";
                        }

                        const processed = {
                            ...order,
                            expectedCNY: expectedCNY.toFixed(2),
                            expectedUSD: expectedUSD.toFixed(2),
                            difference: difference.toFixed(2),
                            exchangeRate: exchangeRate,
                            bracket: bracket.details,
                            addressIsRemote,
                            remoteChargeUSD: remoteChargeUSD.toFixed(2),
                            handlingUSD: handlingUSD.toFixed(2),
                            totalChargedUSD: totalChargedUSD.toFixed(2),
                            remoteStatus
                        };

                        if (addressIsRemote || remoteChargeUSD > 0) {
                            results.remoteOrders.push(processed);
                        }

                        if (Math.abs(difference) < 0.01) results.accurate.push(processed);
                        else if (difference > 0) results.overcharge.push(processed);
                        else results.undercharge.push(processed);
                    }

                    results.missingCarriers = Array.from(missingCarrierMap.entries()).map(([carrier, orderIds]) => ({
                        carrier: carrier,
                        orderCount: orderIds.length,
                        orderIds: orderIds
                    }));

                    updateProgress(100, "‚úÖ Complete!", "All orders processed");
                    addStatusLog(`‚úÖ DONE!`, "success");
                    addStatusLog(`üìà Overcharged: ${results.overcharge.length} orders`, results.overcharge.length ? "error" : "success");
                    addStatusLog(`üìâ Undercharged: ${results.undercharge.length} orders`, results.undercharge.length ? "error" : "success");
                    addStatusLog(`‚úì Accurate: ${results.accurate.length} orders`, "success");
                    addStatusLog(`‚ö† Invalid: ${results.invalid.length} orders`, results.invalid.length ? "error" : "success");
                    addStatusLog(`üìç Remote-related orders: ${results.remoteOrders.length}`, "info");

                    resultsData = results;

                    setTimeout(() => {
                        document.getElementById("progressContainer").classList.add("hidden");
                        displayResults(results);
                    }, 1000);

                } catch (error) {
                    showError(error.message);
                    addStatusLog(`‚ùå Error: ${error.message}`, "error");
                    updateProgress(0, "‚ùå Error", error.message);
                } finally {
                    document.getElementById("analyzeBtn").disabled = false;
                }
            }

            function generateOrderTable(orders, type) {
                if (orders.length === 0) {
                    return `<p style="color: #94a3b8; text-align: center; padding: 2rem;">No ${type} orders</p>`;
                }

                const isInvalid = type === 'invalid';

                return `
                    <div class="table-container">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Order #</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Country</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">State/ZIP</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Weight (kg)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Ship (USD)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Handling (USD)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Remote (USD)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Total (USD)</th>
                                    ${!isInvalid ? `
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Expected (USD)</th>
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Difference</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Bracket</th>
                                    ` : `
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Shipping Carrier</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Issue</th>
                                    `}
                                </tr>
                            </thead>
                            <tbody>
                                ${orders.map((order, idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                        <td style="padding: 0.75rem; font-weight: 500; color: #7c3aed;">${order.orderId}</td>
                                        <td style="padding: 0.75rem; color: #6b7280;">${order.country}</td>
                                        <td style="padding: 0.75rem; color: #6b7280; font-size: 0.8rem;">${order.state || ''} ${order.postCode || ''}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">${order.totalWeight}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.chargedUSD.toFixed ? order.chargedUSD.toFixed(2) : order.chargedUSD}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.handlingUSD || '0.00'}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.remoteChargeUSD || '0.00'}</td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #111827;">$${order.totalChargedUSD || (order.chargedUSD || 0).toFixed?.(2) || order.chargedUSD}</td>
                                        ${!isInvalid ? `
                                            <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.expectedUSD}</td>
                                            <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${parseFloat(order.difference) > 0 ? '#dc2626' : '#059669'};">
                                                ${parseFloat(order.difference) > 0 ? '+' : ''}$${order.difference}
                                            </td>
                                            <td style="padding: 0.75rem; color: #6b7280; font-size: 0.75rem;">${order.bracket}</td>
                                        ` : `
                                            <td style="padding: 0.75rem; color: #6b7280; font-size: 0.875rem;">${order.shippingLine}</td>
                                            <td style="padding: 0.75rem; color: #dc2626; font-size: 0.875rem; font-weight: 600;">${order.reason}</td>
                                        `}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            function generateRemoteTable(remoteOrders) {
                if (!remoteOrders.length) {
                    return `<p style="color: #94a3b8; text-align: center; padding: 1.5rem;">No remote-related orders found.</p>`;
                }

                return `
                    <div class="table-container">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead>
                                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Order #</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Country</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">State / ZIP</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Ship (USD)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Handling (USD)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Remote (USD)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Total (USD)</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Remote Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${remoteOrders.map((o, idx) => `
                                    <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                        <td style="padding: 0.75rem; font-weight: 500; color: #7c3aed;">${o.orderId}</td>
                                        <td style="padding: 0.75rem; color: #6b7280;">${o.country}</td>
                                        <td style="padding: 0.75rem; color: #6b7280; font-size: 0.8rem;">${o.state || ''} ${o.postCode || ''}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${o.chargedUSD.toFixed ? o.chargedUSD.toFixed(2) : o.chargedUSD}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${o.handlingUSD}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${o.remoteChargeUSD}</td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #111827;">$${o.totalChargedUSD}</td>
                                        <td style="padding: 0.75rem; color:
                                            ${o.remoteStatus.startsWith('‚úÖ') ? '#059669'
                                            : o.remoteStatus.startsWith('‚ö†') ? '#d97706'
                                            : o.remoteStatus.startsWith('‚ùå') ? '#dc2626'
                                            : '#6b7280'};">
                                            ${o.remoteStatus}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            function displayResults(results) {
                const container = document.getElementById("resultsContainer");
                container.classList.remove("hidden");

                const overchargeTotal = results.overcharge.reduce((s, o) => s + parseFloat(o.difference), 0);
                const underchargeTotal = Math.abs(results.undercharge.reduce((s, o) => s + parseFloat(o.difference), 0));

                const totalOrders = results.overcharge.length + results.undercharge.length + results.accurate.length + results.invalid.length;
                const accurateOrders = results.accurate.length;
                const accuracyPercentage = totalOrders > 0 ? ((accurateOrders / totalOrders) * 100).toFixed(1) : 0;

                const remoteMismatchCount = results.remoteOrders.filter(o =>
                    o.remoteStatus !== "‚úÖ Remote address & surcharge charged"
                ).length;

                const top10Overcharged = [...results.overcharge]
                    .sort((a, b) => parseFloat(b.difference) - parseFloat(a.difference))
                    .slice(0, 10);

                resultsData = results;

                container.innerHTML = `
                    <div style="margin-bottom: 1.5rem; display: flex; justify-content: flex-end;">
                        <button onclick="shareDashboard(event)" style="background: #2d3748; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            üîó Share Dashboard Link
                        </button>
                    </div>

                    <div class="results-grid" style="margin-bottom: 2rem;">
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #fee2e2; color: #dc2626;">üìà</div>
                            </div>
                            <h3>Overcharged</h3>
                            <div class="result-amount" style="color: #dc2626;">$${overchargeTotal.toFixed(2)}</div>
                            <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">${results.overcharge.length} orders</div>
                            <button class="download-btn" onclick="downloadExcel('overcharge')">üì• Download Excel</button>
                        </div>
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #d1fae5; color: #059669;">üìâ</div>
                            </div>
                            <h3>Undercharged</h3>
                            <div class="result-amount" style="color: #059669;">$${underchargeTotal.toFixed(2)}</div>
                            <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">${results.undercharge.length} orders</div>
                            <button class="download-btn" onclick="downloadExcel('undercharge')">üì• Download Excel</button>
                        </div>
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #fef3c7; color: #d97706;">‚úì</div>
                            </div>
                            <h3>Accurate</h3>
                            <div class="result-amount" style="color: #d97706;">${results.accurate.length}</div>
                            <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 1rem;">orders correctly charged</div>
                            <button class="download-btn" onclick="downloadExcel('accurate')">üì• Download Excel</button>
                        </div>
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #e0f2fe; color: #0369a1;">üìç</div>
                            </div>
                            <h3>Remote-Related Orders</h3>
                            <div class="result-amount" style="color: #0369a1;">${results.remoteOrders.length}</div>
                            <div style="color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem;">
                                ${remoteMismatchCount === 0
                                    ? "All remote surcharges match remote addresses."
                                    : `${remoteMismatchCount} with mismatch between address & surcharge.`}
                            </div>
                            <button class="download-btn" onclick="downloadExcel('remoteOrders')">üì• Download Remote Orders</button>
                        </div>
                    </div>

                    <div class="card" style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fde68a; margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #92400e; margin-bottom: 0.5rem;">Overall Accuracy</h2>
                                <p style="color: #78350f; font-size: 0.875rem;">${accurateOrders} out of ${totalOrders} orders were correctly charged</p>
                            </div>
                            <div style="font-size: 3rem; font-weight: 800; color: #d97706;">${accuracyPercentage}%</div>
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 2rem;">
                        <h2 style="color: #1f2937; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">üìç</span> Remote Address & Surcharge Audit
                        </h2>
                        <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                            This table shows all orders where either the address is remote <strong>or</strong> a remote surcharge was charged.
                            You can quickly see if surcharge logic matches the actual address.
                        </p>
                        ${generateRemoteTable(results.remoteOrders)}
                    </div>

                    <div class="card" style="margin-bottom: 2rem;">
                        <h2 style="color: #1e293b; margin-bottom: 1.5rem;">üìä All Orders - Detailed View</h2>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <button onclick="switchTab('overcharge')" id="tab-overcharge" class="tab-btn active">
                                Overcharged (${results.overcharge.length})
                            </button>
                            <button onclick="switchTab('undercharge')" id="tab-undercharge" class="tab-btn">
                                Undercharged (${results.undercharge.length})
                            </button>
                            <button onclick="switchTab('accurate')" id="tab-accurate" class="tab-btn">
                                Accurate (${results.accurate.length})
                            </button>
                            <button onclick="switchTab('invalid')" id="tab-invalid" class="tab-btn">
                                Invalid (${results.invalid.length})
                            </button>
                        </div>
                        <div class="tab-content" id="content-overcharge" style="display: block;">
                            ${generateOrderTable(results.overcharge, 'overcharge')}
                        </div>
                        <div class="tab-content" id="content-undercharge" style="display: none;">
                            ${generateOrderTable(results.undercharge, 'undercharge')}
                        </div>
                        <div class="tab-content" id="content-accurate" style="display: none;">
                            ${generateOrderTable(results.accurate, 'accurate')}
                        </div>
                        <div class="tab-content" id="content-invalid" style="display: none;">
                            ${generateOrderTable(results.invalid, 'invalid')}
                        </div>
                    </div>
                `;
            }

            function switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`content-${tabName}`).style.display = 'block';
                document.getElementById(`tab-${tabName}`).classList.add('active');
            }

            async function downloadExcel(type) {
                const data = type === 'remoteOrders' ? resultsData.remoteOrders : resultsData[type];
                if (!data || !data.length) {
                    alert("No data available for download");
                    return;
                }

                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet(type.charAt(0).toUpperCase() + type.slice(1));

                const isInvalid = type === 'invalid';

                const headers = isInvalid
                    ? ['Order ID', 'Country', 'State', 'ZIP', 'Weight (kg)', 'Charged CNY', 'Charged USD', 'Shipping Carrier', 'Issue', 'Details']
                    : ['Order ID', 'Country', 'State', 'ZIP', 'Weight (kg)', 'Ship CNY', 'Ship USD', 'Handling USD', 'Remote USD', 'Total USD', 'Expected CNY', 'Expected USD', 'Difference USD', 'Bracket', 'Remote Status', 'Shipping Line'];

                const headerRow = worksheet.addRow(headers);
                headerRow.font = { bold: true };

                data.forEach(order => {
                    if (isInvalid) {
                        worksheet.addRow([
                            order.orderId,
                            order.country,
                            order.state || '',
                            order.postCode || '',
                            order.totalWeight,
                            order.chargedCNY,
                            order.chargedUSD,
                            order.shippingLine,
                            order.reason || '',
                            order.details || ''
                        ]);
                    } else {
                        worksheet.addRow([
                            order.orderId,
                            order.country,
                            order.state || '',
                            order.postCode || '',
                            order.totalWeight,
                            order.chargedCNY,
                            order.chargedUSD,
                            order.handlingUSD,
                            order.remoteChargeUSD,
                            order.totalChargedUSD,
                            order.expectedCNY,
                            order.expectedUSD,
                            order.difference,
                            order.bracket,
                            order.remoteStatus,
                            order.shippingLine
                        ]);
                    }
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}_orders.xlsx`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function shareDashboard(event) {
                if (!resultsData) {
                    alert("No results to share");
                    return;
                }

                const dataStr = JSON.stringify(resultsData);
                const base64Data = btoa(encodeURIComponent(dataStr));
                const url = new URL(window.location.href.split('#')[0]);
                url.hash = 'results=' + base64Data;

                navigator.clipboard.writeText(url.toString()).then(() => {
                    const btn = event.target.closest('button');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Link Copied to Clipboard!';
                    btn.style.background = '#059669';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#2d3748';
                    }, 3000);
                }).catch(err => {
                    prompt("Copy this link to share:", url.toString());
                });

                window.history.pushState({}, '', url);
            }

            function loadResultsFromURL() {
                const hash = window.location.hash;
                if (!hash || !hash.includes('results=')) return;

                try {
                    const base64Data = hash.split('results=')[1];
                    const dataStr = decodeURIComponent(atob(base64Data));
                    const results = JSON.parse(dataStr);

                    resultsData = results;
                    displayResults(results);
                    document.querySelector('.card').style.display = 'none';
                    document.getElementById('resultsContainer').classList.remove('hidden');
                } catch (error) {
                    console.error('Failed to load results from URL:', error);
                }
            }

            window.addEventListener('DOMContentLoaded', () => {
                loadFromURL();
                loadResultsFromURL();
            });
        </script>
    </body>
</html>
