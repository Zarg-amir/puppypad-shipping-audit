<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PuppyPad Shipping Auditor</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #f3e7ff 0%, #e0f2fe 100%);
                min-height: 100vh;
                padding: 2rem;
            }
            .container { max-width: 1200px; margin: 0 auto; }
            .card {
                background: white;
                border-radius: 1rem;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                padding: 2rem;
                margin-bottom: 1.5rem;
            }
            .header { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
            .icon {
                width: 3rem; height: 3rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                border-radius: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.5rem;
            }
            h1 { font-size: 2rem; color: #1f2937; }
            .subtitle { color: #6b7280; font-size: 0.875rem; }
            .form-group { margin-bottom: 1.5rem; }
            label {
                display: block;
                font-weight: 500;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
            }
            input[type="number"] {
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                font-size: 1rem;
                transition: border-color 0.2s;
            }
            input:focus { outline: none; border-color: #8b5cf6; }
            .file-upload {
                border: 2px dashed #d1d5db;
                border-radius: 0.5rem;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: border-color 0.2s;
            }
            .file-upload:hover { border-color: #8b5cf6; }
            .file-upload.has-file { border-color: #8b5cf6; background: #f3e7ff; }
            .file-name { color: #8b5cf6; font-weight: 500; }
            button {
                width: 100%;
                padding: 1rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                color: white;
                border: none;
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            button:hover:not(:disabled) { opacity: 0.9; }
            button:disabled { opacity: 0.5; cursor: not-allowed; }
            .progress-container {
                background: white;
                border-radius: 0.5rem;
                padding: 1.5rem;
                margin: 1rem 0;
                border: 2px solid #e0d5f7;
            }
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .progress-text { font-weight: 600; color: #7c3aed; font-size: 1rem; }
            .progress-percentage { font-weight: 700; color: #7c3aed; font-size: 1.5rem; }
            .progress-bar-container {
                width: 100%;
                height: 8px;
                background: #e0d5f7;
                border-radius: 999px;
                overflow: hidden;
                margin-bottom: 0.75rem;
            }
            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%);
                border-radius: 999px;
                transition: width 0.3s ease;
                width: 0%;
            }
            .progress-status { color: #6b7280; font-size: 0.875rem; }
            .status-log {
                background: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                max-height: 150px;
                overflow-y: auto;
                font-size: 0.813rem;
                font-family: monospace;
                margin-top: 1rem;
            }
            .status-line { margin-bottom: 0.25rem; color: #6b7280; }
            .status-line.success { color: #10b981; }
            .status-line.error { color: #ef4444; }
            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                margin-top: 1.5rem;
            }
            .result-card {
                background: white;
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .result-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .result-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
            }
            .result-amount { font-size: 1.75rem; font-weight: bold; margin: 0.5rem 0; }
            .download-btn {
                padding: 0.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: background 0.2s;
                width: auto;
            }
            .error-box {
                background: #fef2f2;
                border: 2px solid #fecaca;
                color: #991b1b;
                padding: 1rem;
                border-radius: 0.5rem;
                margin: 1rem 0;
            }
            .hidden { display: none; }
            table {
                border-collapse: collapse;
                width: 100%;
            }
            th, td {
                padding: 0.75rem;
                text-align: left;
            }
            th {
                font-weight: 600;
                color: #374151;
                background: #f9fafb;
                border-bottom: 2px solid #e5e7eb;
            }
            td {
                color: #6b7280;
                border-bottom: 1px solid #e5e7eb;
            }
            tr:hover {
                background: #f3f4f6;
            }
            .tab-btn:hover {
                background: #f9fafb;
            }
            .accordion {
                background: white;
                border: 2px solid #e5e7eb;
                border-radius: 0.75rem;
                overflow: hidden;
                margin-bottom: 1.5rem;
            }
            .accordion-header {
                padding: 1.5rem;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #f9fafb;
                transition: background 0.2s;
            }
            .accordion-header:hover {
                background: #f3f4f6;
            }
            .accordion-header.invalid {
                background: #fef2f2;
                border-bottom: 2px solid #fecaca;
            }
            .accordion-header.invalid:hover {
                background: #fee2e2;
            }
            .accordion-title {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-size: 1.25rem;
                font-weight: 600;
            }
            .accordion-chevron {
                font-size: 1.5rem;
                transition: transform 0.3s ease;
            }
            .accordion-chevron.open {
                transform: rotate(180deg);
            }
            .accordion-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }
            .accordion-content.open {
                max-height: 5000px;
                padding: 1.5rem;
            }
            .missing-carriers-table {
                background: #fff7ed;
                border: 2px solid #fed7aa;
                border-radius: 0.75rem;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <div class="header">
                    <div class="icon">‚ö°</div>
                    <div>
                        <h1>PuppyPad Shipping Auditor</h1>
                        <div class="subtitle">‚ö° Super Fast - 1 AI Call + Pure JavaScript</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Shipping Line Charges Excel File</label>
                    <div class="file-upload" id="ratesUpload" onclick="document.getElementById('ratesFile').click()">
                        <span id="ratesLabel">üìÅ Click to upload Excel file</span>
                    </div>
                    <input type="file" id="ratesFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('rates')" />
                </div>
                <div class="form-group">
                    <label>Exchange Rate (CNY to USD)</label>
                    <input type="number" id="exchangeRate" value="6.9" step="0.01" />
                </div>
                <div class="form-group">
                    <label>Mrek Orders Excel File</label>
                    <div class="file-upload" id="ordersUpload" onclick="document.getElementById('ordersFile').click()">
                        <span id="ordersLabel">üìÅ Click to upload Excel file</span>
                    </div>
                    <input type="file" id="ordersFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('orders')" />
                </div>
                <div id="errorBox" class="error-box hidden"></div>
                <div id="progressContainer" class="progress-container hidden">
                    <div class="progress-header">
                        <div class="progress-text" id="progressText">Initializing...</div>
                        <div class="progress-percentage" id="progressPercent">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-status" id="progressStatus">Preparing...</div>
                    <div class="status-log" id="statusLog"></div>
                </div>
                <button id="analyzeBtn" onclick="analyzeOrders()">‚ö° Analyze All Orders (Super Fast!)</button>
            </div>
            <div id="resultsContainer" class="hidden"></div>
        </div>
        <script>
            let ratesData = null, ordersData = null;
            
            function handleFileSelect(type) {
                const input = document.getElementById(type + "File");
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });
                    if (type === "rates") {
                        ratesData = jsonData;
                        document.getElementById("ratesUpload").classList.add("has-file");
                        document.getElementById("ratesLabel").innerHTML = `<span class="file-name">${file.name} (${jsonData.length} rows)</span>`;
                    } else {
                        ordersData = jsonData;
                        document.getElementById("ordersUpload").classList.add("has-file");
                        document.getElementById("ordersLabel").innerHTML = `<span class="file-name">${file.name} (${jsonData.length} rows)</span>`;
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function updateProgress(percent, text, status) {
                document.getElementById("progressContainer").classList.remove("hidden");
                document.getElementById("progressBar").style.width = percent + "%";
                document.getElementById("progressPercent").textContent = Math.round(percent) + "%";
                document.getElementById("progressText").textContent = text;
                if (status) document.getElementById("progressStatus").textContent = status;
            }
            
            function addStatusLog(message, type = "info") {
                const log = document.getElementById("statusLog");
                const line = document.createElement("div");
                line.className = `status-line ${type}`;
                line.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                log.appendChild(line);
                log.scrollTop = log.scrollHeight;
            }
            
            function showError(message) {
                document.getElementById("errorBox").textContent = message;
                document.getElementById("errorBox").classList.remove("hidden");
            }
            
            async function callOpenAI(prompt) {
                const response = await fetch("/api/openai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            { role: "system", content: "Return ONLY valid JSON. No markdown, no explanation." },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0,
                        max_tokens: 1000,
                    }),
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API failed: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                if (!data.choices?.[0]?.message?.content) throw new Error("Invalid API response");
                return data.choices[0].message.content;
            }
            
            function extractJSON(text) {
                let cleaned = text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                const match = cleaned.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                if (match) cleaned = match[0];
                return JSON.parse(cleaned);
            }
            
            function parseWeightRange(rangeStr) {
                if (!rangeStr || typeof rangeStr !== 'string') return null;
                const match = rangeStr.match(/([\d.]+)[Ôºú<].*?[‚â§<=]([\d.]+)/);
                if (!match) return null;
                return {
                    minWeight: parseFloat(match[1]),
                    maxWeight: parseFloat(match[2])
                };
            }
            
            function containsChinese(text) {
                return /[\u4e00-\u9fa5]/.test(text);
            }

            async function translateChinese(text) {
                if (!containsChinese(text)) return text;
                try {
                    const prompt = `Translate this Chinese shipping carrier/method name to English. Return ONLY the English translation, nothing else: "${text}"`;
                    const response = await callOpenAI(prompt);
                    return response.trim().replace(/["""]/g, '');
                } catch (error) {
                    console.error('Translation error:', error);
                    return text; // Return original if translation fails
                }
            }

            function normalizeShippingLine(text) {
                return text ? text.toLowerCase().replace(/^[^-]+-/, '').replace(/\s+/g, '').replace(/[()ÔºàÔºâ]/g, '') : "";
            }

            function matchShippingLine(orderLine, rateLine, orderLineEn = '', rateLineEn = '') {
                const o = normalizeShippingLine(orderLine);
                const r = normalizeShippingLine(rateLine);
                const oEn = normalizeShippingLine(orderLineEn);
                const rEn = normalizeShippingLine(rateLineEn);

                // Try exact and partial matches with original and translated text
                return o.includes(r) || r.includes(o) ||
                       (oEn && rEn && (oEn.includes(rEn) || rEn.includes(oEn))) ||
                       (oEn && (oEn.includes(r) || r.includes(oEn))) ||
                       (rEn && (o.includes(rEn) || rEn.includes(o)));
            }
            
            async function analyzeOrders() {
                document.getElementById("analyzeBtn").disabled = true;
                document.getElementById("errorBox").classList.add("hidden");
                document.getElementById("statusLog").innerHTML = "";
                document.getElementById("resultsContainer").innerHTML = "";
                document.getElementById("resultsContainer").classList.add("hidden");
                
                try {
                    if (!ratesData || !ordersData) throw new Error("Upload both files");
                    const exchangeRate = parseFloat(document.getElementById("exchangeRate").value);
                    if (isNaN(exchangeRate) || exchangeRate <= 0) throw new Error("Invalid exchange rate");
                    
                    // Step 1: Parse rate sheet with JavaScript (FAST!)
                    updateProgress(5, "‚ö° Parsing Rate Sheet", "Using JavaScript - instant!");
                    addStatusLog(`Rate sheet: ${ratesData.length} rows, Orders: ${ordersData.length} rows`);
                    addStatusLog("‚ö° Parsing rate sheet with pure JavaScript...");
                    
                    let shippingLineName = ratesData[1][0] ? String(ratesData[1][0]).trim() : "";
                    addStatusLog(`Found shipping line: ${shippingLineName}`);

                    // Translate shipping line name if it contains Chinese
                    let shippingLineNameEn = shippingLineName;
                    if (containsChinese(shippingLineName)) {
                        updateProgress(10, "üåê Translating Chinese", "Translating shipping carrier name...");
                        addStatusLog(`Detected Chinese in shipping line name, translating...`);
                        shippingLineNameEn = await translateChinese(shippingLineName);
                        addStatusLog(`Translation: "${shippingLineName}" ‚Üí "${shippingLineNameEn}"`, "success");
                    }
                    
                    const ratesByCountry = {};
                    const countryMapping = {}; // Maps normalized -> original
                    let currentCountry = null;
                    
                    for (let i = 2; i < ratesData.length; i++) {
                        const row = ratesData[i];
                        if (!row || row.length < 6) continue;
                        
                        if (row[0] && typeof row[0] === 'string' && row[0].trim()) {
                            currentCountry = row[0].trim();
                            const normalized = currentCountry.toUpperCase();
                            ratesByCountry[normalized] = [];
                            countryMapping[normalized] = currentCountry;
                        }
                        
                        const weightRange = row[2];
                        const costPerKg = row[5];
                        const regFee = row[6];
                        
                        if (currentCountry && weightRange && costPerKg) {
                            const weights = parseWeightRange(weightRange);
                            if (weights) {
                                const normalized = currentCountry.toUpperCase();
                                ratesByCountry[normalized].push({
                                    minWeight: weights.minWeight,
                                    maxWeight: weights.maxWeight,
                                    costPerKg: parseFloat(costPerKg),
                                    regFee: parseFloat(regFee) || 0,
                                    details: `${weights.minWeight}-${weights.maxWeight}kg @ ¬•${costPerKg}/kg + ¬•${regFee || 0} reg`
                                });
                            }
                        }
                    }
                    
                    const totalCountries = Object.keys(ratesByCountry).length;
                    const totalBrackets = Object.values(ratesByCountry).reduce((s, b) => s + b.length, 0);
                    
                    updateProgress(20, "‚úÖ Rate Sheet Parsed", `${totalCountries} countries, ${totalBrackets} brackets`);
                    addStatusLog(`‚úÖ Parsed ${totalCountries} countries with ${totalBrackets} rate brackets`, "success");
                    
                    // Log found countries for debugging
                    const countries = Object.keys(countryMapping).map(k => countryMapping[k]).join(", ");
                    addStatusLog(`Countries: ${countries}`);
                    
                    if (totalBrackets === 0) {
                        throw new Error("No rate brackets found in rate sheet");
                    }
                    
                    // Step 2: Use AI only for column detection (FAST!)
                    updateProgress(25, "ü§ñ AI Detecting Columns", "One quick AI call...");
                    addStatusLog("ü§ñ Using AI to detect order columns...");
                    
                    const orderSample = ordersData.slice(0, 3).map(r => r.join("|")).join("\n");
                    const colPrompt = `Identify column indices (0-based) in this data:
${orderSample}

Return ONLY JSON: {"orderIdCol":0,"countryCol":1,"weightCol":2,"cnyCostCol":3,"usdCostCol":4,"shippingLineCol":5}`;
                    
                    const colResponse = await callOpenAI(colPrompt);
                    const colMap = extractJSON(colResponse);
                    
                    updateProgress(40, "‚úÖ Columns Detected", "AI analysis complete");
                    addStatusLog(`‚úÖ Detected: Order=${colMap.orderIdCol}, Country=${colMap.countryCol}, Weight=${colMap.weightCol}`, "success");
                    
                    // Step 3: Parse all orders with JavaScript (FAST!)
                    updateProgress(45, "üìä Parsing Orders", "Extracting all order data...");
                    addStatusLog("üìä Parsing orders with JavaScript...");
                    
                    const allOrders = [];
                    for (let i = 1; i < ordersData.length; i++) {
                        const row = ordersData[i];
                        if (!row || !row[colMap.orderIdCol]) continue;
                        
                        allOrders.push({
                            orderId: String(row[colMap.orderIdCol] || "").trim(),
                            country: String(row[colMap.countryCol] || "").trim(),
                            totalWeight: parseFloat(row[colMap.weightCol]) || 0,
                            chargedCNY: parseFloat(row[colMap.cnyCostCol]) || 0,
                            chargedUSD: parseFloat(row[colMap.usdCostCol]) || 0,
                            shippingLine: String(row[colMap.shippingLineCol] || "").trim(),
                        });
                    }
                    
                    updateProgress(50, "‚úÖ Orders Parsed", `${allOrders.length} orders ready`);
                    addStatusLog(`‚úÖ Parsed ${allOrders.length} valid orders from ${ordersData.length} rows`, "success");
                    
                    // Step 4: Match orders to rates (FAST!)
                    updateProgress(55, "‚ö° Matching Orders", "Processing at high speed...");
                    addStatusLog("‚ö° Matching orders to rates (JavaScript - blazing fast)...");
                    
                    const results = { overcharge: [], undercharge: [], accurate: [], invalid: [], missingCarriers: [] };
                    const total = allOrders.length;
                    const missingCarrierMap = new Map(); // Track unique missing carriers
                    
                    // Cache for translated order shipping lines to avoid repeated translations
                    const translationCache = new Map();

                    for (let i = 0; i < total; i++) {
                        const order = allOrders[i];

                        if (i % 100 === 0) {
                            const percent = 55 + (i / total) * 40;
                            updateProgress(percent, "‚ö° Processing", `${i}/${total} orders (${Math.round(i/total*100)}%)`);
                        }

                        // Translate order shipping line if it contains Chinese (with caching)
                        let orderShippingLineEn = order.shippingLine;
                        if (containsChinese(order.shippingLine)) {
                            if (translationCache.has(order.shippingLine)) {
                                orderShippingLineEn = translationCache.get(order.shippingLine);
                            } else {
                                orderShippingLineEn = await translateChinese(order.shippingLine);
                                translationCache.set(order.shippingLine, orderShippingLineEn);
                                addStatusLog(`Translated order carrier: "${order.shippingLine}" ‚Üí "${orderShippingLineEn}"`);
                            }
                        }

                        if (!matchShippingLine(order.shippingLine, shippingLineName, orderShippingLineEn, shippingLineNameEn)) {
                            // Track this as a missing carrier
                            const carrierKey = containsChinese(order.shippingLine) ?
                                `${order.shippingLine} (${orderShippingLineEn})` :
                                order.shippingLine;

                            if (!missingCarrierMap.has(carrierKey)) {
                                missingCarrierMap.set(carrierKey, []);
                            }
                            missingCarrierMap.get(carrierKey).push(order.orderId);

                            const rateCarrierDisplay = containsChinese(shippingLineName) ?
                                `${shippingLineName} (${shippingLineNameEn})` :
                                shippingLineName;

                            results.invalid.push({
                                ...order,
                                reason: `Shipping carrier/method mismatch`,
                                details: `Order uses shipping carrier "${carrierKey}" which doesn't match the rate sheet carrier "${rateCarrierDisplay}". This carrier may not be available in the current rate sheet.`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }

                        const normalizedCountry = order.country.toUpperCase();
                        const countryRates = ratesByCountry[normalizedCountry];
                        if (!countryRates || countryRates.length === 0) {
                            // More specific error for blank country vs country not in rate sheet
                            let errorReason, errorDetails;
                            if (!order.country || order.country.trim() === "") {
                                errorReason = "Missing country information";
                                errorDetails = "No country has been specified for this order. Please add the destination country to calculate shipping rates.";
                            } else {
                                errorReason = `Country "${order.country}" not found in rate sheet`;
                                errorDetails = `The destination country "${order.country}" does not have shipping rates in the current rate sheet. Please request rates for this country from Mrek.`;
                            }
                            results.invalid.push({
                                ...order,
                                reason: errorReason,
                                details: errorDetails,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }
                        
                        const bracket = countryRates.find(b => order.totalWeight > b.minWeight && order.totalWeight <= b.maxWeight);
                        if (!bracket) {
                            // Find the available weight ranges for this country
                            const availableRanges = countryRates.map(b => `${b.minWeight}-${b.maxWeight}kg`).join(', ');
                            results.invalid.push({
                                ...order,
                                reason: `Weight ${order.totalWeight}kg out of range for ${order.country}`,
                                details: `No shipping rate found for weight ${order.totalWeight}kg to ${order.country}. Available weight ranges: ${availableRanges}. The order weight may be too light or too heavy for the available brackets.`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }
                        
                        const expectedCNY = (order.totalWeight * bracket.costPerKg) + bracket.regFee;
                        const expectedUSD = expectedCNY / exchangeRate;
                        const difference = order.chargedUSD - expectedUSD;
                        
                        const processed = {
                            ...order,
                            expectedCNY: expectedCNY.toFixed(2),
                            expectedUSD: expectedUSD.toFixed(2),
                            difference: difference.toFixed(2),
                            exchangeRate: exchangeRate,
                            bracket: bracket.details,
                        };
                        
                        if (Math.abs(difference) < 0.01) results.accurate.push(processed);
                        else if (difference > 0) results.overcharge.push(processed);
                        else results.undercharge.push(processed);
                    }
                    
                    // Convert missing carriers map to array
                    results.missingCarriers = Array.from(missingCarrierMap.entries()).map(([carrier, orderIds]) => ({
                        carrier: carrier,
                        orderCount: orderIds.length,
                        orderIds: orderIds
                    }));

                    updateProgress(100, "‚úÖ Complete!", "All orders processed");
                    addStatusLog(`‚úÖ DONE! Analysis complete`, "success");
                    addStatusLog(`üìà Overcharged: ${results.overcharge.length} orders`, results.overcharge.length > 0 ? "error" : "success");
                    addStatusLog(`üìâ Undercharged: ${results.undercharge.length} orders`, results.undercharge.length > 0 ? "error" : "success");
                    addStatusLog(`‚úì Accurate: ${results.accurate.length} orders`, "success");
                    addStatusLog(`‚ö† Invalid: ${results.invalid.length} orders`, results.invalid.length > 0 ? "error" : "success");
                    if (results.missingCarriers.length > 0) {
                        addStatusLog(`üì¶ Missing Carriers: ${results.missingCarriers.length} different carriers not found`, "error");
                    }
                    
                    setTimeout(() => {
                        document.getElementById("progressContainer").classList.add("hidden");
                        displayResults(results);
                    }, 1000);
                    
                } catch (error) {
                    showError(error.message);
                    addStatusLog(`‚ùå Error: ${error.message}`, "error");
                    updateProgress(0, "‚ùå Error", error.message);
                } finally {
                    document.getElementById("analyzeBtn").disabled = false;
                }
            }
            
            function displayResults(results) {
                const container = document.getElementById("resultsContainer");
                container.classList.remove("hidden");
                
                const overchargeTotal = results.overcharge.reduce((s, o) => s + parseFloat(o.difference), 0);
                const underchargeTotal = Math.abs(results.undercharge.reduce((s, o) => s + parseFloat(o.difference), 0));
                
                // Calculate overall accuracy
                const totalOrders = results.overcharge.length + results.undercharge.length + results.accurate.length + results.invalid.length;
                const accurateOrders = results.accurate.length;
                const accuracyPercentage = totalOrders > 0 ? ((accurateOrders / totalOrders) * 100).toFixed(1) : 0;
                
                // Top 10 overcharged orders
                const top10Overcharged = [...results.overcharge]
                    .sort((a, b) => parseFloat(b.difference) - parseFloat(a.difference))
                    .slice(0, 10);
                
                // Country breakdown for overcharges
                const countryCounts = {};
                results.overcharge.forEach(o => {
                    countryCounts[o.country] = (countryCounts[o.country] || 0) + 1;
                });
                const topCountries = Object.entries(countryCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                // Invalid reasons breakdown with examples
                const invalidByReason = {};
                results.invalid.forEach(o => {
                    const reason = o.reason;
                    if (!invalidByReason[reason]) {
                        invalidByReason[reason] = [];
                    }
                    if (invalidByReason[reason].length < 3) { // Keep up to 3 examples per reason
                        invalidByReason[reason].push(o);
                    }
                });
                
                window.resultsData = results;
                
                container.innerHTML = `
                    <!-- Missing Carriers Alert -->
                    ${results.missingCarriers.length > 0 ? `
                    <div class="missing-carriers-table">
                        <h2 style="color: #92400e; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">üì¶</span> Missing Shipping Carriers/Methods - Action Required
                        </h2>
                        <p style="color: #78350f; margin-bottom: 1.5rem; font-size: 0.95rem;">
                            The following shipping carriers/methods were found in your orders but don't have rate sheets. Please request these rate sheets from Mrek to process these ${results.missingCarriers.reduce((total, item) => total + item.orderCount, 0)} orders.
                        </p>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; overflow: hidden;">
                                <thead>
                                    <tr style="background: #fed7aa; border-bottom: 2px solid #fdba74;">
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #92400e;">Shipping Carrier/Method</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #92400e;">Number of Orders</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #92400e;">Sample Order IDs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.missingCarriers.map((item, idx) => `
                                        <tr style="border-bottom: 1px solid #fed7aa; ${idx % 2 === 0 ? 'background: #fffbeb;' : 'background: white;'}">
                                            <td style="padding: 1rem; font-weight: 600; color: #78350f;">${item.carrier}</td>
                                            <td style="padding: 1rem; text-align: center; color: #92400e; font-weight: 600; font-size: 1.1rem;">${item.orderCount}</td>
                                            <td style="padding: 1rem; color: #6b7280; font-size: 0.875rem;">${item.orderIds.slice(0, 5).join(', ')}${item.orderIds.length > 5 ? '...' : ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Summary Cards -->
                    <div class="results-grid" style="margin-bottom: 2rem;">
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #fee2e2; color: #dc2626;">üìà</div>
                            </div>
                            <h3>Overcharged</h3>
                            <div class="result-amount" style="color: #dc2626;">$${overchargeTotal.toFixed(2)}</div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">${results.overcharge.length} orders</div>
                            <button class="download-btn" onclick="downloadCSV('overcharge')" style="background: #fee2e2; color: #dc2626; width: 100%; padding: 0.5rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer;">
                                üì• Download File
                            </button>
                        </div>
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #d1fae5; color: #059669;">üìâ</div>
                            </div>
                            <h3>Undercharged</h3>
                            <div class="result-amount" style="color: #059669;">$${underchargeTotal.toFixed(2)}</div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">${results.undercharge.length} orders</div>
                            <button class="download-btn" onclick="downloadCSV('undercharge')" style="background: #d1fae5; color: #059669; width: 100%; padding: 0.5rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer;">
                                üì• Download File
                            </button>
                        </div>
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #dbeafe; color: #2563eb;">‚úì</div>
                            </div>
                            <h3>Accurate</h3>
                            <div class="result-amount" style="color: #2563eb;">${results.accurate.length}</div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">orders correctly charged</div>
                            <button class="download-btn" onclick="downloadCSV('accurate')" style="background: #dbeafe; color: #2563eb; width: 100%; padding: 0.5rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer;">
                                üì• Download File
                            </button>
                        </div>
                        <div class="result-card">
                            <div class="result-header">
                                <div class="result-icon" style="background: #f3f4f6; color: #6b7280;">‚ö†</div>
                            </div>
                            <h3>Invalid</h3>
                            <div class="result-amount" style="color: #6b7280;">${results.invalid.length}</div>
                            <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 1rem;">orders with issues</div>
                            <button class="download-btn" onclick="downloadCSV('invalid')" style="background: #f3f4f6; color: #6b7280; width: 100%; padding: 0.5rem; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer;">
                                üì• Download File
                            </button>
                        </div>
                    </div>
                    
                    <!-- Overall Accuracy Card -->
                    <div class="card" style="background: linear-gradient(135deg, #f3e7ff 0%, #e0f2fe 100%); border: 2px solid #8b5cf6; margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #7c3aed; margin-bottom: 0.5rem;">Overall Accuracy</h2>
                                <p style="color: #6b7280; font-size: 0.875rem;">${accurateOrders} out of ${totalOrders} orders were correctly charged</p>
                            </div>
                            <div style="font-size: 3rem; font-weight: bold; color: #7c3aed;">${accuracyPercentage}%</div>
                        </div>
                    </div>
                    
                    <!-- Top 10 Overcharged Orders -->
                    ${top10Overcharged.length > 0 ? `
                    <div class="card" style="margin-bottom: 2rem;">
                        <h2 style="color: #1f2937; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">üî•</span> Top 10 Overcharged Orders
                        </h2>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                <thead>
                                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Order #</th>
                                        <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Country</th>
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Weight (kg)</th>
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Charged (USD)</th>
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Charged (CNY)</th>
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Expected (USD)</th>
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Expected (CNY)</th>
                                        <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Overcharge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${top10Overcharged.map((order, idx) => `
                                        <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                            <td style="padding: 0.75rem; font-weight: 500; color: #7c3aed;">${order.orderId}</td>
                                            <td style="padding: 0.75rem; color: #6b7280;">${order.country}</td>
                                            <td style="padding: 0.75rem; text-align: right; color: #6b7280;">${order.totalWeight}</td>
                                            <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.chargedUSD}</td>
                                            <td style="padding: 0.75rem; text-align: right; color: #6b7280;">¬•${order.chargedCNY}</td>
                                            <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.expectedUSD}</td>
                                            <td style="padding: 0.75rem; text-align: right; color: #6b7280;">¬•${order.expectedCNY}</td>
                                            <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #dc2626;">+$${order.difference}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Country Breakdown -->
                    ${topCountries.length > 0 ? `
                    <div class="card" style="margin-bottom: 2rem;">
                        <h2 style="color: #1f2937; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.5rem;">üåç</span> Overcharges by Country
                        </h2>
                        <div style="display: grid; gap: 0.75rem;">
                            ${topCountries.map(([country, count]) => {
                                const countryTotal = results.overcharge
                                    .filter(o => o.country === country)
                                    .reduce((sum, o) => sum + parseFloat(o.difference), 0);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">${country}</div>
                                            <div style="font-size: 0.875rem; color: #6b7280;">${count} orders overcharged</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 700; font-size: 1.25rem; color: #dc2626;">$${countryTotal.toFixed(2)}</div>
                                            <div style="font-size: 0.75rem; color: #6b7280;">total overcharge</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Invalid Orders Accordion (Closed by Default) -->
                    ${results.invalid.length > 0 ? `
                    <div class="accordion">
                        <div class="accordion-header invalid" onclick="toggleAccordion('invalid-orders')">
                            <div class="accordion-title" style="color: #991b1b;">
                                <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                                <span>Invalid Orders - What Went Wrong (${results.invalid.length} orders)</span>
                            </div>
                            <div class="accordion-chevron" id="chevron-invalid-orders">‚ñº</div>
                        </div>
                        <div class="accordion-content" id="content-invalid-orders">
                            <p style="color: #6b7280; margin-bottom: 1.5rem; font-size: 0.95rem;">
                                ${results.invalid.length} orders couldn't be matched to rates. Here are the specific issues with detailed explanations:
                            </p>
                            <div style="display: grid; gap: 1.5rem;">
                                ${Object.entries(invalidByReason).map(([reason, examples]) => {
                                    return `
                                        <div style="background: white; border-radius: 0.75rem; border: 2px solid #fecaca; padding: 1.5rem;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                <div>
                                                    <h3 style="color: #991b1b; font-size: 1.1rem; margin-bottom: 0.5rem;">${reason}</h3>
                                                    ${examples[0].details ? `<p style="color: #6b7280; font-size: 0.875rem; line-height: 1.5;">${examples[0].details}</p>` : ''}
                                                </div>
                                                <div style="background: #fecaca; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.875rem;">
                                                    ${invalidByReason[reason].length}+ orders
                                                </div>
                                            </div>

                                            <div style="background: #fef9f5; border-left: 3px solid #f59e0b; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                                                <div style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem; font-size: 0.875rem;">üìã Examples from your orders:</div>
                                                ${examples.map((example, idx) => `
                                                    <div style="margin-bottom: ${idx < examples.length - 1 ? '0.75rem' : '0'}; padding-bottom: ${idx < examples.length - 1 ? '0.75rem' : '0'}; border-bottom: ${idx < examples.length - 1 ? '1px solid #fde68a' : 'none'};">
                                                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.813rem;">
                                                            <span style="font-weight: 600; color: #92400e;">Order ID:</span>
                                                            <span style="color: #6b7280;">${example.orderId}</span>

                                                            <span style="font-weight: 600; color: #92400e;">Country:</span>
                                                            <span style="color: #6b7280;">${example.country || '(blank)'}</span>

                                                            <span style="font-weight: 600; color: #92400e;">Weight:</span>
                                                            <span style="color: #6b7280;">${example.totalWeight} kg</span>

                                                            <span style="font-weight: 600; color: #92400e;">Shipping Carrier:</span>
                                                            <span style="color: #6b7280;">${example.shippingLine}</span>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Tabbed Orders View -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <h2 style="color: #1f2937; margin-bottom: 1rem;">üìä All Orders - Detailed View</h2>
                        
                        <!-- Tab Navigation -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0;">
                            <button onclick="switchTab('overcharge')" id="tab-overcharge" class="tab-btn active-tab" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid #dc2626; color: #dc2626; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Overcharged (${results.overcharge.length})
                            </button>
                            <button onclick="switchTab('undercharge')" id="tab-undercharge" class="tab-btn" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Undercharged (${results.undercharge.length})
                            </button>
                            <button onclick="switchTab('accurate')" id="tab-accurate" class="tab-btn" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Accurate (${results.accurate.length})
                            </button>
                            <button onclick="switchTab('invalid')" id="tab-invalid" class="tab-btn" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                Invalid (${results.invalid.length})
                            </button>
                        </div>
                        
                        <!-- Tab Content: Overcharge -->
                        <div id="content-overcharge" class="tab-content" style="overflow-x: auto;">
                            ${generateOrderTable(results.overcharge, 'overcharge')}
                        </div>
                        
                        <!-- Tab Content: Undercharge -->
                        <div id="content-undercharge" class="tab-content" style="display: none; overflow-x: auto;">
                            ${generateOrderTable(results.undercharge, 'undercharge')}
                        </div>
                        
                        <!-- Tab Content: Accurate -->
                        <div id="content-accurate" class="tab-content" style="display: none; overflow-x: auto;">
                            ${generateOrderTable(results.accurate, 'accurate')}
                        </div>
                        
                        <!-- Tab Content: Invalid -->
                        <div id="content-invalid" class="tab-content" style="display: none; overflow-x: auto;">
                            ${generateOrderTable(results.invalid, 'invalid')}
                        </div>
                    </div>
                `;
            }
            
            function generateOrderTable(orders, type) {
                if (orders.length === 0) {
                    return `<p style="color: #6b7280; text-align: center; padding: 2rem;">No ${type} orders</p>`;
                }
                
                const isInvalid = type === 'invalid';
                
                return `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Order #</th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Country</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Weight (kg)</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Charged (USD)</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Charged (CNY)</th>
                                ${!isInvalid ? `
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Expected (USD)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Expected (CNY)</th>
                                    <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">Difference</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Bracket</th>
                                ` : `
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Shipping Carrier</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Issue</th>
                                    <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">Details</th>
                                `}
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map((order, idx) => `
                                <tr style="border-bottom: 1px solid #e5e7eb; ${idx % 2 === 0 ? 'background: #f9fafb;' : ''}">
                                    <td style="padding: 0.75rem; font-weight: 500; color: #7c3aed;">${order.orderId}</td>
                                    <td style="padding: 0.75rem; color: #6b7280;">${order.country}</td>
                                    <td style="padding: 0.75rem; text-align: right; color: #6b7280;">${order.totalWeight}</td>
                                    <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.chargedUSD}</td>
                                    <td style="padding: 0.75rem; text-align: right; color: #6b7280;">¬•${order.chargedCNY}</td>
                                    ${!isInvalid ? `
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">$${order.expectedUSD}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: #6b7280;">¬•${order.expectedCNY}</td>
                                        <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: ${parseFloat(order.difference) > 0 ? '#dc2626' : '#059669'};">
                                            ${parseFloat(order.difference) > 0 ? '+' : ''}$${order.difference}
                                        </td>
                                        <td style="padding: 0.75rem; color: #6b7280; font-size: 0.75rem;">${order.bracket}</td>
                                    ` : `
                                        <td style="padding: 0.75rem; color: #6b7280; font-size: 0.875rem;">${order.shippingLine}</td>
                                        <td style="padding: 0.75rem; color: #dc2626; font-size: 0.875rem; font-weight: 600;">${order.reason}</td>
                                        <td style="padding: 0.75rem; color: #6b7280; font-size: 0.813rem; line-height: 1.4;">${order.details || ''}</td>
                                    `}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            function toggleAccordion(id) {
                const content = document.getElementById(`content-${id}`);
                const chevron = document.getElementById(`chevron-${id}`);

                if (content.classList.contains('open')) {
                    content.classList.remove('open');
                    chevron.classList.remove('open');
                } else {
                    content.classList.add('open');
                    chevron.classList.add('open');
                }
            }

            function switchTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });

                // Remove active styling from all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.style.borderBottom = '3px solid transparent';
                    btn.style.color = '#6b7280';
                });

                // Show selected tab content
                document.getElementById(`content-${tabName}`).style.display = 'block';

                // Add active styling to selected tab
                const activeTab = document.getElementById(`tab-${tabName}`);
                const colors = {
                    overcharge: '#dc2626',
                    undercharge: '#059669',
                    accurate: '#2563eb',
                    invalid: '#6b7280'
                };
                activeTab.style.borderBottom = `3px solid ${colors[tabName]}`;
                activeTab.style.color = colors[tabName];
            }
            
            function downloadCSV(type) {
                const data = window.resultsData[type];
                if (!data || !data.length) { alert("No data"); return; }
                const headers = ["Order ID","Country","Weight (kg)","Charged CNY","Charged USD","Expected CNY","Expected USD","Exchange Rate","Difference USD","Bracket","Shipping Line",data[0].reason?"Reason":""].filter(Boolean);
                let csv = headers.join(",") + "\n";
                let totalCNY = 0, totalUSD = 0, totalExpCNY = 0, totalExpUSD = 0, totalDiff = 0;
                data.forEach(o => {
                    csv += [o.orderId,o.country||"",o.totalWeight,o.chargedCNY,o.chargedUSD,o.expectedCNY,o.expectedUSD,o.exchangeRate||"",o.difference,`"${o.bracket}"`,o.shippingLine,o.reason||""].filter((_,i)=>i<headers.length).join(",")+"\n";
                    if(o.expectedCNY!=="N/A"){totalCNY+=parseFloat(o.chargedCNY);totalUSD+=parseFloat(o.chargedUSD);totalExpCNY+=parseFloat(o.expectedCNY);totalExpUSD+=parseFloat(o.expectedUSD);totalDiff+=parseFloat(o.difference);}
                });
                csv+="\n"+["TOTAL","","",totalCNY.toFixed(2),totalUSD.toFixed(2),totalExpCNY.toFixed(2),totalExpUSD.toFixed(2),"",totalDiff.toFixed(2),"","",""].slice(0,headers.length).join(",");
                const a=document.createElement("a");
                a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
                a.download=`${type}_orders.csv`;
                a.click();
            }
        </script>
    </body>
</html>
