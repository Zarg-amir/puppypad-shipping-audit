<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PuppyPad Shipping Auditor</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #f3e7ff 0%, #e0f2fe 100%);
                min-height: 100vh;
                padding: 2rem;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .card {
                background: white;
                border-radius: 1rem;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                padding: 2rem;
                margin-bottom: 1.5rem;
            }
            .header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 2rem;
            }
            .icon {
                width: 3rem;
                height: 3rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                border-radius: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.5rem;
            }
            h1 {
                font-size: 2rem;
                color: #1f2937;
            }
            .subtitle {
                color: #6b7280;
                font-size: 0.875rem;
            }
            .form-group {
                margin-bottom: 1.5rem;
            }
            label {
                display: block;
                font-weight: 500;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
            }
            input[type="number"] {
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                font-size: 1rem;
                transition: border-color 0.2s;
            }
            input:focus {
                outline: none;
                border-color: #8b5cf6;
            }
            .file-upload {
                border: 2px dashed #d1d5db;
                border-radius: 0.5rem;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: border-color 0.2s;
            }
            .file-upload:hover {
                border-color: #8b5cf6;
            }
            .file-upload.has-file {
                border-color: #8b5cf6;
                background: #f3e7ff;
            }
            .file-name {
                color: #8b5cf6;
                font-weight: 500;
            }
            button {
                width: 100%;
                padding: 1rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                color: white;
                border: none;
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            button:hover:not(:disabled) {
                opacity: 0.9;
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .log-box {
                background: #f9fafb;
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                max-height: 200px;
                overflow-y: auto;
                margin: 1rem 0;
                font-size: 0.875rem;
            }
            .console-log {
                background: #1f2937;
                color: #9ca3af;
                border: 2px solid #374151;
                border-radius: 0.5rem;
                padding: 1rem;
                max-height: 300px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 0.75rem;
            }
            .console-line {
                margin-bottom: 0.25rem;
            }
            .console-time {
                color: #6b7280;
            }
            .console-success {
                color: #10b981;
            }
            .console-error {
                color: #ef4444;
            }
            .console-warning {
                color: #f59e0b;
            }
            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                margin-top: 1.5rem;
            }
            .result-card {
                background: white;
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .result-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .result-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
            }
            .result-amount {
                font-size: 1.75rem;
                font-weight: bold;
                margin: 0.5rem 0;
            }
            .download-btn {
                padding: 0.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: background 0.2s;
                width: auto;
            }
            .error-box {
                background: #fef2f2;
                border: 2px solid #fecaca;
                color: #991b1b;
                padding: 1rem;
                border-radius: 0.5rem;
                margin: 1rem 0;
            }
            .hidden {
                display: none;
            }
            .progress-box {
                background: #f3e7ff;
                border: 2px solid #e0d5f7;
                padding: 1.5rem;
                border-radius: 0.5rem;
                margin: 1rem 0;
            }
            .progress-text {
                font-weight: 600;
                color: #7c3aed;
                margin-bottom: 0.5rem;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <div class="header">
                    <div class="icon">‚ö°</div>
                    <div>
                        <h1>PuppyPad Shipping Auditor</h1>
                        <div class="subtitle">
                            ‚ö° Fast Mode - Powered by OpenAI GPT-4o-mini
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Shipping Line Charges Excel File</label>
                    <div
                        class="file-upload"
                        id="ratesUpload"
                        onclick="document.getElementById('ratesFile').click()"
                    >
                        <span id="ratesLabel"
                            >üìÅ Click to upload Excel file</span
                        >
                    </div>
                    <input
                        type="file"
                        id="ratesFile"
                        accept=".xlsx,.xls"
                        style="display: none"
                        onchange="handleFileSelect('rates')"
                    />
                </div>

                <div class="form-group">
                    <label>Exchange Rate (CNY to USD)</label>
                    <input
                        type="number"
                        id="exchangeRate"
                        value="6.9"
                        step="0.01"
                    />
                </div>

                <div class="form-group">
                    <label>Mrek Orders Excel File</label>
                    <div
                        class="file-upload"
                        id="ordersUpload"
                        onclick="document.getElementById('ordersFile').click()"
                    >
                        <span id="ordersLabel"
                            >üìÅ Click to upload Excel file</span
                        >
                    </div>
                    <input
                        type="file"
                        id="ordersFile"
                        accept=".xlsx,.xls"
                        style="display: none"
                        onchange="handleFileSelect('orders')"
                    />
                </div>

                <div id="errorBox" class="error-box hidden"></div>
                <div id="logBox" class="log-box hidden"></div>
                <div id="consoleBox" class="console-log hidden">
                    <div
                        style="
                            border-bottom: 1px solid #374151;
                            padding-bottom: 0.5rem;
                            margin-bottom: 0.5rem;
                            color: #d1d5db;
                        "
                    >
                        Debug Console
                    </div>
                    <div id="consoleContent"></div>
                </div>

                <div id="progressBox" class="progress-box hidden">
                    <div class="progress-text" id="progressText">
                        Initializing...
                    </div>
                </div>

                <button id="analyzeBtn" onclick="analyzeOrders()">
                    ‚ö° Analyze Shipping Costs (Fast Mode)
                </button>
            </div>

            <div id="resultsContainer" class="hidden"></div>
        </div>

        <script>
            let ratesData = null;
            let ordersData = null;

            function handleFileSelect(type) {
                const input = document.getElementById(type + "File");
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1,
                        defval: "",
                    });

                    if (type === "rates") {
                        ratesData = jsonData;
                        document
                            .getElementById("ratesUpload")
                            .classList.add("has-file");
                        document.getElementById("ratesLabel").innerHTML =
                            `<span class="file-name">${file.name}</span>`;
                    } else {
                        ordersData = jsonData;
                        document
                            .getElementById("ordersUpload")
                            .classList.add("has-file");
                        document.getElementById("ordersLabel").innerHTML =
                            `<span class="file-name">${file.name}</span>`;
                    }
                    addConsoleLog(
                        `‚úÖ Loaded ${jsonData.length} rows from ${file.name}`,
                        "success",
                    );
                };
                reader.readAsArrayBuffer(file);
            }

            function addLog(message) {
                const logBox = document.getElementById("logBox");
                logBox.classList.remove("hidden");
                logBox.innerHTML += `<div>${message}</div>`;
                logBox.scrollTop = logBox.scrollHeight;
            }

            function addConsoleLog(message, type = "info") {
                const consoleBox = document.getElementById("consoleBox");
                const consoleContent =
                    document.getElementById("consoleContent");
                consoleBox.classList.remove("hidden");

                const time = new Date().toLocaleTimeString();
                const colorClass =
                    type === "error"
                        ? "console-error"
                        : type === "success"
                          ? "console-success"
                          : type === "warning"
                            ? "console-warning"
                            : "";

                consoleContent.innerHTML += `<div class="console-line"><span class="console-time">${time}</span> <span class="${colorClass}">${message}</span></div>`;
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }

            function showError(message) {
                document.getElementById("errorBox").textContent = message;
                document.getElementById("errorBox").classList.remove("hidden");
            }

            function setProgress(message) {
                document
                    .getElementById("progressBox")
                    .classList.remove("hidden");
                document.getElementById("progressText").textContent = message;
            }

            async function callOpenAI(prompt) {
                addConsoleLog("ü§ñ Calling OpenAI GPT-4o-mini...");
                const response = await fetch("/api/openai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system",
                                content:
                                    "You are a data extraction expert. Return only valid JSON, no markdown.",
                            },
                            { role: "user", content: prompt },
                        ],
                        temperature: 0,
                        max_tokens: 4000,
                    }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addConsoleLog(
                        `‚ùå OpenAI API Error: ${response.status}`,
                        "error",
                    );
                    throw new Error(`OpenAI API failed: ${response.status}`);
                }

                const data = await response.json();
                addConsoleLog("‚úÖ OpenAI response received", "success");
                return data.choices[0].message.content;
            }

            function extractJSON(text) {
                addConsoleLog("üîç Extracting JSON from AI response...");
                let cleaned = text
                    .replace(/```json\n?/g, "")
                    .replace(/```\n?/g, "")
                    .trim();
                const match = cleaned.match(/\[[\s\S]*\]|\{[\s\S]*\}/);
                if (match) cleaned = match[0];

                try {
                    const result = JSON.parse(
                        cleaned.replace(/[""]/g, '"').replace(/['']/g, "'"),
                    );
                    addConsoleLog(`‚úÖ Successfully parsed JSON`, "success");
                    return result;
                } catch (e) {
                    addConsoleLog(`‚ùå JSON parse error: ${e.message}`, "error");
                    addConsoleLog(
                        `Raw text: ${cleaned.substring(0, 200)}...`,
                        "error",
                    );
                    throw new Error(`Failed to parse JSON: ${e.message}`);
                }
            }

            async function analyzeOrders() {
                document.getElementById("analyzeBtn").disabled = true;
                document.getElementById("errorBox").classList.add("hidden");
                document.getElementById("logBox").innerHTML = "";
                document.getElementById("consoleContent").innerHTML = "";
                document.getElementById("resultsContainer").innerHTML = "";
                document
                    .getElementById("resultsContainer")
                    .classList.add("hidden");

                addConsoleLog(
                    "üöÄ FAST MODE: OpenAI GPT-4o-mini - AI used only 2 times!",
                    "success",
                );

                try {
                    if (!ratesData || !ordersData)
                        throw new Error("Please upload both Excel files");

                    const rate = parseFloat(
                        document.getElementById("exchangeRate").value,
                    );
                    if (isNaN(rate) || rate <= 0)
                        throw new Error("Invalid exchange rate");

                    setProgress(
                        "ü§ñ AI Call #1: Analyzing rate sheet structure...",
                    );
                    addLog("ü§ñ AI analyzing rate sheet (ONE TIME)...");
                    addConsoleLog("üìä Sending rate sheet sample to AI...");

                    const ratesText = ratesData
                        .slice(0, 100)
                        .map((row) => row.join("|"))
                        .join("\n");
                    const ratesPrompt = `Analyze this shipping rate sheet. Extract ALL weight brackets with costs.

Data: ${ratesText}

Return JSON: [{"name":"line name","brackets":[{"minWeight":0,"maxWeight":0.1,"costCNY":100,"details":"0-0.1kg @ ¬•100"}]}]

Parse ranges like "0ÔºúW‚â§0.1" to minWeight/maxWeight. Return ONLY JSON.`;

                    const ratesJsonRaw = await callOpenAI(ratesPrompt);
                    const rateSheets = extractJSON(ratesJsonRaw);

                    if (!Array.isArray(rateSheets)) {
                        addConsoleLog(
                            `‚ùå Expected array but got: ${typeof rateSheets}`,
                            "error",
                        );
                        throw new Error(
                            "Rate sheet parsing failed - did not return an array",
                        );
                    }

                    const totalBrackets = rateSheets.reduce(
                        (sum, s) => sum + (s.brackets ? s.brackets.length : 0),
                        0,
                    );
                    addConsoleLog(
                        `‚úÖ AI extracted ${rateSheets.length} shipping lines with ${totalBrackets} rate brackets`,
                        "success",
                    );
                    addLog(`‚úÖ Found ${rateSheets.length} shipping line(s)`);

                    setProgress(
                        "ü§ñ AI Call #2: Detecting order column format...",
                    );
                    addLog("ü§ñ AI detecting order format (ONE TIME)...");
                    addConsoleLog("üîç Analyzing order sheet columns...");

                    const sampleText = ordersData
                        .slice(0, 6)
                        .map((row) => row.join("|"))
                        .join("\n");
                    const formatPrompt = `Identify column indices in this order data.

Data: ${sampleText}

Return JSON: {"orderIdCol":0,"weightCol":1,"cnyCostCol":2,"usdCostCol":3,"shippingLineCol":4}

Column indices (0-based) for: order ID, weight (kg), cost CNY, cost USD, shipping line. Return ONLY JSON.`;

                    const formatJsonRaw = await callOpenAI(formatPrompt);
                    const colMap = extractJSON(formatJsonRaw);
                    addConsoleLog(
                        `‚úÖ AI identified columns: Order=${colMap.orderIdCol}, Weight=${colMap.weightCol}, CNY=${colMap.cnyCostCol}, USD=${colMap.usdCostCol}, Line=${colMap.shippingLineCol}`,
                        "success",
                    );

                    setProgress(
                        "‚ö° FAST PARSING: Processing all orders with JavaScript...",
                    );
                    addLog(
                        `‚ö° Fast parsing ${ordersData.length - 1} orders...`,
                    );
                    addConsoleLog(
                        "‚ö° No more AI calls - pure JavaScript speed!",
                    );

                    const allOrders = [];
                    for (let i = 1; i < ordersData.length; i++) {
                        const row = ordersData[i];
                        if (!row || !row[colMap.orderIdCol]) continue;

                        const order = {
                            orderId: String(
                                row[colMap.orderIdCol] || "",
                            ).trim(),
                            totalWeight: parseFloat(row[colMap.weightCol]) || 0,
                            chargedCNY: parseFloat(row[colMap.cnyCostCol]) || 0,
                            chargedUSD: parseFloat(row[colMap.usdCostCol]) || 0,
                            shippingLine: String(
                                row[colMap.shippingLineCol] || "",
                            ).trim(),
                        };

                        if (
                            order.orderId &&
                            order.totalWeight > 0 &&
                            order.shippingLine
                        ) {
                            allOrders.push(order);
                        }
                    }

                    addConsoleLog(
                        `‚úÖ Parsed ${allOrders.length} valid orders in milliseconds!`,
                        "success",
                    );
                    addLog(`‚úÖ Extracted ${allOrders.length} orders`);

                    setProgress(
                        "‚öñÔ∏è FAST COMPARISON: Checking all orders against rates...",
                    );
                    addLog("‚öñÔ∏è Comparing all orders...");
                    addConsoleLog("üîç Running comparison logic...");

                    const results = {
                        overcharge: [],
                        undercharge: [],
                        accurate: [],
                        invalid: [],
                    };

                    allOrders.forEach((order) => {
                        const sheetData = rateSheets.find(
                            (sheet) =>
                                order.shippingLine
                                    .toLowerCase()
                                    .includes(sheet.name.toLowerCase()) ||
                                sheet.name
                                    .toLowerCase()
                                    .includes(order.shippingLine.toLowerCase()),
                        );

                        if (!sheetData) {
                            results.invalid.push({
                                ...order,
                                reason: `No rate sheet for: ${order.shippingLine}`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            return;
                        }

                        const bracket = sheetData.brackets.find(
                            (b) =>
                                order.totalWeight > b.minWeight &&
                                order.totalWeight <= b.maxWeight,
                        );

                        if (!bracket) {
                            results.invalid.push({
                                ...order,
                                reason: `No bracket for ${order.totalWeight}kg`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            return;
                        }

                        const expectedCNY = bracket.costCNY;
                        const expectedUSD = expectedCNY / rate;
                        const difference = order.chargedUSD - expectedUSD;

                        const processed = {
                            ...order,
                            expectedCNY: expectedCNY.toFixed(2),
                            expectedUSD: expectedUSD.toFixed(2),
                            difference: difference.toFixed(2),
                            exchangeRate: rate,
                            bracket: bracket.details,
                        };

                        if (Math.abs(difference) < 0.01) {
                            results.accurate.push(processed);
                        } else if (difference > 0) {
                            results.overcharge.push(processed);
                        } else {
                            results.undercharge.push(processed);
                        }
                    });

                    addLog("‚ú® Analysis complete!");
                    addConsoleLog(
                        `‚úÖ DONE! ${results.overcharge.length} overcharged, ${results.undercharge.length} undercharged, ${results.accurate.length} accurate, ${results.invalid.length} invalid`,
                        "success",
                    );
                    addConsoleLog(
                        "‚ö° Total OpenAI calls: 2 (fast mode!)",
                        "success",
                    );

                    displayResults(results);
                } catch (error) {
                    showError(error.message);
                    addLog(`‚ùå Error: ${error.message}`);
                    addConsoleLog(`‚ùå FATAL: ${error.message}`, "error");
                } finally {
                    document.getElementById("analyzeBtn").disabled = false;
                    document
                        .getElementById("progressBox")
                        .classList.add("hidden");
                }
            }

            function displayResults(results) {
                const container = document.getElementById("resultsContainer");
                container.classList.remove("hidden");

                const overchargeTotal = results.overcharge.reduce(
                    (sum, o) => sum + parseFloat(o.difference),
                    0,
                );
                const underchargeTotal = Math.abs(
                    results.undercharge.reduce(
                        (sum, o) => sum + parseFloat(o.difference),
                        0,
                    ),
                );

                window.resultsData = results;

                container.innerHTML = `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #fee2e2; color: #dc2626;">üìà</div>
                            <button class="download-btn" onclick="downloadCSV('overcharge')" style="background: #fee2e2; color: #dc2626;">üíæ</button>
                        </div>
                        <h3>Overcharged</h3>
                        <div class="result-amount" style="color: #dc2626;">$${overchargeTotal.toFixed(2)}</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.overcharge.length} orders</div>
                    </div>

                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #d1fae5; color: #059669;">üìâ</div>
                            <button class="download-btn" onclick="downloadCSV('undercharge')" style="background: #d1fae5; color: #059669;">üíæ</button>
                        </div>
                        <h3>Undercharged</h3>
                        <div class="result-amount" style="color: #059669;">$${underchargeTotal.toFixed(2)}</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.undercharge.length} orders</div>
                    </div>

                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #dbeafe; color: #2563eb;">‚úì</div>
                            <button class="download-btn" onclick="downloadCSV('accurate')" style="background: #dbeafe; color: #2563eb;">üíæ</button>
                        </div>
                        <h3>Accurate</h3>
                        <div class="result-amount" style="color: #2563eb;">100%</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.accurate.length} orders</div>
                    </div>

                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #f3f4f6; color: #6b7280;">‚ö†</div>
                            <button class="download-btn" onclick="downloadCSV('invalid')" style="background: #f3f4f6; color: #6b7280;">üíæ</button>
                        </div>
                        <h3>Invalid</h3>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">${results.invalid.length} orders</div>
                    </div>
                </div>
            `;
            }

            function downloadCSV(type) {
                const data = window.resultsData[type];
                if (!data || data.length === 0) {
                    alert("No data to download");
                    return;
                }

                const headers = [
                    "Order ID",
                    "Total Weight (kg)",
                    "Charged CNY",
                    "Charged USD",
                    "Expected CNY",
                    "Expected USD",
                    "Exchange Rate",
                    "Difference USD",
                    "Weight Bracket",
                    "Shipping Line",
                    data[0].reason ? "Reason" : "",
                ].filter(Boolean);

                let csv = headers.join(",") + "\n";
                let totalChargedCNY = 0,
                    totalChargedUSD = 0,
                    totalExpectedCNY = 0,
                    totalExpectedUSD = 0,
                    totalDifference = 0;

                data.forEach((order) => {
                    const row = [
                        order.orderId,
                        order.totalWeight,
                        order.chargedCNY,
                        order.chargedUSD,
                        order.expectedCNY,
                        order.expectedUSD,
                        order.exchangeRate || "",
                        order.difference,
                        `"${order.bracket}"`,
                        order.shippingLine,
                        order.reason || "",
                    ].filter((_, i) => i < headers.length);
                    csv += row.join(",") + "\n";

                    if (order.expectedCNY !== "N/A") {
                        totalChargedCNY += order.chargedCNY;
                        totalChargedUSD += order.chargedUSD;
                        totalExpectedCNY += parseFloat(order.expectedCNY);
                        totalExpectedUSD += parseFloat(order.expectedUSD);
                        totalDifference += parseFloat(order.difference);
                    }
                });

                csv +=
                    "\n" +
                    [
                        "TOTAL",
                        "",
                        totalChargedCNY.toFixed(2),
                        totalChargedUSD.toFixed(2),
                        totalExpectedCNY.toFixed(2),
                        totalExpectedUSD.toFixed(2),
                        "",
                        totalDifference.toFixed(2),
                        "",
                        "",
                        "",
                    ]
                        .slice(0, headers.length)
                        .join(",");

                const blob = new Blob([csv], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${type}_orders.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }
        </script>
    </body>
</html>
