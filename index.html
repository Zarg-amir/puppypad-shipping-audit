<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PuppyPad Shipping Auditor</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }

            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: #ffffff;
                min-height: 100vh;
                color: #1e293b;
            }

            /* Navbar */
            .navbar {
                background: #ffffff;
                border-bottom: 1px solid #e2e8f0;
                padding: 1rem 2rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .navbar-brand {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .navbar-logo {
                width: 40px;
                height: 40px;
            }

            .navbar-title {
                font-size: 1.25rem;
                font-weight: 700;
                color: #1e293b;
            }

            .share-btn {
                padding: 0.625rem 1.25rem;
                background: #3b82f6;
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.875rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .share-btn:hover:not(:disabled) {
                background: #2563eb;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            }

            .share-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* Main Content */
            .main-content {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem;
            }

            .input-section {
                background: #f8fafc;
                border-radius: 12px;
                padding: 2rem;
                margin-bottom: 2rem;
            }

            .section-header {
                margin-bottom: 1.5rem;
            }

            .section-title {
                font-size: 1.125rem;
                font-weight: 700;
                color: #0f172a;
                margin-bottom: 0.25rem;
            }

            .section-subtitle {
                font-size: 0.875rem;
                color: #64748b;
            }

            .form-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
                margin-bottom: 1.5rem;
            }

            @media (max-width: 768px) {
                .form-grid {
                    grid-template-columns: 1fr;
                }
            }

            .form-group {
                background: white;
                padding: 1.25rem;
                border-radius: 10px;
                border: 1px solid #e2e8f0;
            }

            .form-label {
                display: block;
                font-weight: 600;
                color: #334155;
                margin-bottom: 0.75rem;
                font-size: 0.875rem;
            }

            .input-toggle {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 1rem;
                background: #f1f5f9;
                padding: 0.25rem;
                border-radius: 8px;
            }

            .toggle-btn {
                flex: 1;
                padding: 0.5rem 1rem;
                background: transparent;
                border: none;
                border-radius: 6px;
                color: #64748b;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.813rem;
            }

            .toggle-btn.active {
                background: white;
                color: #3b82f6;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .input-option {
                display: none;
            }

            .input-option.active {
                display: block;
            }

            .link-input-wrapper {
                display: flex;
                gap: 0.5rem;
            }

            input[type="text"], input[type="number"] {
                width: 100%;
                padding: 0.75rem;
                border: 1px solid #cbd5e1;
                border-radius: 8px;
                font-size: 0.875rem;
                transition: all 0.2s;
                font-family: 'Inter', sans-serif;
            }

            input[readonly] {
                background: #f8fafc;
                color: #64748b;
            }

            input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .edit-btn {
                padding: 0.75rem 1rem;
                background: #f1f5f9;
                border: 1px solid #cbd5e1;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 1rem;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .edit-btn:hover {
                background: #e2e8f0;
            }

            .file-upload {
                border: 2px dashed #cbd5e1;
                border-radius: 8px;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                background: #fafafa;
                color: #64748b;
            }

            .file-upload:hover {
                border-color: #3b82f6;
                background: #eff6ff;
            }

            .file-upload.has-file {
                border-color: #3b82f6;
                background: #eff6ff;
            }

            .file-name {
                color: #3b82f6;
                font-weight: 600;
            }

            .action-row {
                display: flex;
                gap: 1rem;
                align-items: flex-end;
            }

            .exchange-rate-input {
                flex: 0 0 200px;
            }

            .analyze-btn {
                flex: 1;
                padding: 1rem 2rem;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
                box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
            }

            .analyze-btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            }

            .analyze-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            /* Progress */
            .progress-container {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }

            .progress-text {
                font-weight: 600;
                color: #3b82f6;
            }

            .progress-bar-container {
                width: 100%;
                height: 8px;
                background: #e2e8f0;
                border-radius: 999px;
                overflow: hidden;
                margin-bottom: 0.75rem;
            }

            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
                border-radius: 999px;
                transition: width 0.3s ease;
                width: 0%;
            }

            /* Results */
            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-bottom: 2rem;
            }

            .result-card {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 1.5rem;
                transition: all 0.2s;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .result-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
            }

            .result-icon {
                width: 3rem;
                height: 3rem;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }

            .result-amount {
                font-size: 2rem;
                font-weight: 800;
                margin: 0.5rem 0;
            }

            .result-label {
                color: #64748b;
                font-size: 0.875rem;
                margin-bottom: 1rem;
            }

            .card {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .card h2 {
                font-size: 1.25rem;
                font-weight: 700;
                color: #0f172a;
                margin-bottom: 1rem;
            }

            /* Buttons */
            button {
                font-family: 'Inter', sans-serif;
            }

            .download-btn {
                width: 100%;
                padding: 0.75rem;
                background: #0f172a;
                color: white;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.875rem;
            }

            .download-btn:hover {
                background: #1e293b;
                transform: translateY(-1px);
            }

            .tab-btn {
                padding: 0.625rem 1rem;
                background: #f1f5f9;
                border: none;
                border-radius: 8px;
                color: #64748b;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 0.875rem;
            }

            .tab-btn:hover {
                background: #e2e8f0;
            }

            .tab-btn.active {
                background: #3b82f6;
                color: white;
            }

            /* Tables */
            .table-container {
                max-height: 500px;
                overflow-y: auto;
                border-radius: 10px;
                border: 1px solid #e2e8f0;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                background: white;
            }

            th {
                padding: 0.875rem;
                text-align: left;
                font-weight: 600;
                color: #475569;
                background: #f8fafc;
                border-bottom: 2px solid #e2e8f0;
                font-size: 0.8125rem;
                position: sticky;
                top: 0;
            }

            td {
                padding: 0.875rem;
                color: #334155;
                border-bottom: 1px solid #f1f5f9;
                font-size: 0.875rem;
            }

            tr:hover {
                background: #f8fafc;
            }

            /* Accordion */
            .accordion {
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 12px;
                overflow: hidden;
                margin-bottom: 1.5rem;
            }

            .accordion-header {
                padding: 1.5rem;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #fef2f2;
                transition: all 0.2s;
            }

            .accordion-header:hover {
                background: #fee2e2;
            }

            .accordion-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }

            .accordion-content.open {
                max-height: 5000px;
                padding: 1.5rem;
            }

            .hidden {
                display: none !important;
            }

            .error-box {
                background: #fef2f2;
                border: 1px solid #fecaca;
                color: #991b1b;
                padding: 1rem;
                border-radius: 10px;
                margin-bottom: 1rem;
            }

            .status-log {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 1rem;
                max-height: 150px;
                overflow-y: auto;
                font-size: 0.813rem;
                font-family: 'Courier New', monospace;
                margin-top: 1rem;
            }

            .status-line {
                margin-bottom: 0.25rem;
                color: #64748b;
            }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="https://cdn.shopify.com/s/files/1/0433/0510/7612/files/navyblue-logo.svg?v=1754231041" alt="PuppyPad Logo" class="navbar-logo">
                <div class="navbar-title">PuppyPad Shipping Auditor</div>
            </div>
            <button id="shareBtn" class="share-btn hidden" onclick="shareDashboard(event)">
                üîó Share Dashboard
            </button>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Input Section -->
            <div id="inputSection" class="input-section">
                <div class="section-header">
                    <div class="section-title">Analyze Shipping Charges</div>
                    <div class="section-subtitle">Upload your shipping rates and orders to identify overcharges and undercharges</div>
                </div>

                <div class="form-grid">
                    <!-- Shipping Rates -->
                    <div class="form-group">
                        <label class="form-label">üìä Shipping Line Charges</label>
                        <div class="input-toggle">
                            <button class="toggle-btn" onclick="toggleInputType('rates', 'upload')">Upload File</button>
                            <button class="toggle-btn active" onclick="toggleInputType('rates', 'link')">Google Sheet</button>
                        </div>
                        <div class="input-option" id="rates-upload">
                            <div class="file-upload" id="ratesUpload" onclick="document.getElementById('ratesFile').click()">
                                <span id="ratesLabel">üìÑ Click to upload Excel file</span>
                            </div>
                            <input type="file" id="ratesFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('rates')" />
                        </div>
                        <div class="input-option active" id="rates-link">
                            <div class="link-input-wrapper">
                                <input type="text" id="ratesLink" value="https://docs.google.com/spreadsheets/d/1TngHNKi-FWJcvstK0DDd51coh7ndDUQweXDTMSAFdSg/edit?usp=sharing" readonly>
                                <button class="edit-btn" onclick="toggleEditLink('rates')" title="Edit link">‚úèÔ∏è</button>
                            </div>
                        </div>
                    </div>

                    <!-- Orders -->
                    <div class="form-group">
                        <label class="form-label">üì¶ Mrek Orders</label>
                        <div class="input-toggle">
                            <button class="toggle-btn" onclick="toggleInputType('orders', 'upload')">Upload File</button>
                            <button class="toggle-btn active" onclick="toggleInputType('orders', 'link')">Google Sheet</button>
                        </div>
                        <div class="input-option" id="orders-upload">
                            <div class="file-upload" id="ordersUpload" onclick="document.getElementById('ordersFile').click()">
                                <span id="ordersLabel">üìÑ Click to upload Excel file</span>
                            </div>
                            <input type="file" id="ordersFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('orders')" />
                        </div>
                        <div class="input-option active" id="orders-link">
                            <div class="link-input-wrapper">
                                <input type="text" id="ordersLink" value="https://docs.google.com/spreadsheets/d/1TngHNKi-FWJcvstK0DDd51coh7ndDUQweXDTMSAFdSg/edit?usp=sharing" readonly>
                                <button class="edit-btn" onclick="toggleEditLink('orders')" title="Edit link">‚úèÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="errorBox" class="error-box hidden"></div>

                <div class="action-row">
                    <div class="exchange-rate-input">
                        <label class="form-label">Exchange Rate (CNY to USD)</label>
                        <input type="number" id="exchangeRate" value="6.9" step="0.01" />
                    </div>
                    <button id="analyzeBtn" class="analyze-btn" onclick="analyzeOrders()">üìä Analyze All Orders</button>
                </div>
            </div>

            <!-- Progress -->
            <div id="progressContainer" class="progress-container hidden">
                <div class="progress-header">
                    <div class="progress-text" id="progressText">Initializing...</div>
                    <div style="font-weight: 700; color: #3b82f6; font-size: 1.5rem;" id="progressPercent">0%</div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div style="color: #64748b; font-size: 0.875rem;" id="progressStatus">Preparing...</div>
                <div class="status-log" id="statusLog"></div>
            </div>

            <!-- Results -->
            <div id="resultsContainer"></div>
        </div>

        <script>
            let ratesData = null, ordersData = null;
            let isLoadingRates = false, isLoadingOrders = false;

            // Load Google Sheets on page load
            window.addEventListener('DOMContentLoaded', () => {
                loadFromURL();
                loadResultsFromURL();

                // Auto-load default Google Sheets
                const ratesLink = document.getElementById('ratesLink').value;
                const ordersLink = document.getElementById('ordersLink').value;

                if (ratesLink) {
                    handleLinkInput('rates');
                }
                if (ordersLink) {
                    handleLinkInput('orders');
                }
            });

            function handleFileSelect(type) {
                const input = document.getElementById(type + "File");
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });
                    if (type === "rates") {
                        ratesData = jsonData;
                        document.getElementById("ratesUpload").classList.add("has-file");
                        document.getElementById("ratesLabel").innerHTML = `<span class="file-name">‚úì ${file.name} (${jsonData.length} rows)</span>`;
                    } else {
                        ordersData = jsonData;
                        document.getElementById("ordersUpload").classList.add("has-file");
                        document.getElementById("ordersLabel").innerHTML = `<span class="file-name">‚úì ${file.name} (${jsonData.length} rows)</span>`;
                    }
                };
                reader.readAsArrayBuffer(file);
                saveToURL();
            }

            function toggleInputType(type, inputType) {
                const uploadOption = document.getElementById(`${type}-upload`);
                const linkOption = document.getElementById(`${type}-link`);
                const buttonsContainer = uploadOption.parentElement.querySelector('.input-toggle');
                const buttons = buttonsContainer.querySelectorAll('.toggle-btn');

                buttons.forEach(btn => btn.classList.remove('active'));
                buttons.forEach(btn => {
                    if ((inputType === 'upload' && btn.textContent.includes('Upload')) ||
                        (inputType === 'link' && btn.textContent.includes('Sheet'))) {
                        btn.classList.add('active');
                    }
                });

                uploadOption.classList.remove('active');
                linkOption.classList.remove('active');
                document.getElementById(`${type}-${inputType}`).classList.add('active');
            }

            function toggleEditLink(type) {
                const input = document.getElementById(type + 'Link');
                const btn = event.target;

                if (input.readOnly) {
                    input.readOnly = false;
                    input.focus();
                    input.select();
                    btn.textContent = '‚úì';
                    btn.style.background = '#10b981';
                    btn.style.color = '#ffffff';
                } else {
                    input.readOnly = true;
                    btn.textContent = '‚úèÔ∏è';
                    btn.style.background = '#f1f5f9';
                    btn.style.color = '#000000';
                    handleLinkInput(type);
                }
            }

            async function handleLinkInput(type) {
                const link = document.getElementById(type + "Link").value;
                if (!link) return;

                try {
                    // Set loading state
                    if (type === 'rates') {
                        isLoadingRates = true;
                    } else {
                        isLoadingOrders = true;
                    }

                    // Extract sheet ID from Google Sheets URL
                    const match = link.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                    if (!match) {
                        showError("Invalid Google Sheets URL");
                        return;
                    }

                    const sheetId = match[1];
                    const exportUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;

                    const response = await fetch(exportUrl);
                    if (!response.ok) {
                        throw new Error('Failed to load Google Sheet');
                    }

                    const arrayBuffer = await response.arrayBuffer();
                    const data = new Uint8Array(arrayBuffer);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });

                    if (type === "rates") {
                        ratesData = jsonData;
                        isLoadingRates = false;
                        console.log('Loaded rates data:', jsonData.length, 'rows');
                    } else {
                        ordersData = jsonData;
                        isLoadingOrders = false;
                        console.log('Loaded orders data:', jsonData.length, 'rows');
                    }

                    saveToURL();
                } catch (error) {
                    console.error('Error loading Google Sheet:', error);
                    if (type === 'rates') {
                        isLoadingRates = false;
                    } else {
                        isLoadingOrders = false;
                    }
                    showError("Failed to load Google Sheet. Make sure it's publicly accessible.");
                }
            }

            function saveToURL() {
                const exchangeRate = document.getElementById('exchangeRate').value;
                const url = new URL(window.location);
                url.searchParams.set('exchangeRate', exchangeRate);
                window.history.pushState({}, '', url);
            }

            function loadFromURL() {
                const url = new URL(window.location);
                const exchangeRate = url.searchParams.get('exchangeRate');
                if (exchangeRate) {
                    document.getElementById('exchangeRate').value = exchangeRate;
                }
            }

            function updateProgress(percent, text, status) {
                document.getElementById("progressContainer").classList.remove("hidden");
                document.getElementById("progressBar").style.width = percent + "%";
                document.getElementById("progressPercent").textContent = Math.round(percent) + "%";
                document.getElementById("progressText").textContent = text;
                if (status) document.getElementById("progressStatus").textContent = status;
            }

            function addStatusLog(message, type = "info") {
                const log = document.getElementById("statusLog");
                const line = document.createElement("div");
                line.className = `status-line ${type}`;
                line.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                log.appendChild(line);
                log.scrollTop = log.scrollHeight;
            }

            function showError(message) {
                document.getElementById("errorBox").textContent = message;
                document.getElementById("errorBox").classList.remove("hidden");
            }

            async function callOpenAI(prompt) {
                const response = await fetch("/api/openai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            { role: "system", content: "Return ONLY valid JSON. No markdown, no explanation." },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0,
                        max_tokens: 1000,
                    }),
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API failed: ${response.status} - ${errorText}`);
                }
                const data = await response.json();
                if (!data.choices?.[0]?.message?.content) throw new Error("Invalid API response");
                return data.choices[0].message.content;
            }

            function extractJSON(text) {
                let cleaned = text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                const match = cleaned.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                if (match) cleaned = match[0];
                return JSON.parse(cleaned);
            }

            function parseWeightRange(rangeStr) {
                if (!rangeStr || typeof rangeStr !== 'string') return null;
                const match = rangeStr.match(/([\d.]+)[Ôºú<].*?[‚â§<=]([\d.]+)/);
                if (!match) return null;
                return {
                    minWeight: parseFloat(match[1]),
                    maxWeight: parseFloat(match[2])
                };
            }

            function containsChinese(text) {
                return /[\u4e00-\u9fa5]/.test(text);
            }

            async function translateChinese(text) {
                if (!containsChinese(text)) return text;
                try {
                    const prompt = `Translate this Chinese shipping carrier/method name to English. Return ONLY the English translation, nothing else: "${text}"`;
                    const response = await callOpenAI(prompt);
                    return response.trim().replace(/["""]/g, '');
                } catch (error) {
                    console.error('Translation error:', error);
                    return text;
                }
            }

            function normalizeShippingLine(text) {
                return text ? text.toLowerCase().replace(/^[^-]+-/, '').replace(/\s+/g, '').replace(/[()ÔºàÔºâ]/g, '') : "";
            }

            function matchShippingLine(orderLine, rateLine, orderLineEn = '', rateLineEn = '') {
                const o = normalizeShippingLine(orderLine);
                const r = normalizeShippingLine(rateLine);
                const oEn = normalizeShippingLine(orderLineEn);
                const rEn = normalizeShippingLine(rateLineEn);

                return o.includes(r) || r.includes(o) ||
                       (oEn && rEn && (oEn.includes(rEn) || rEn.includes(oEn))) ||
                       (oEn && (oEn.includes(r) || r.includes(oEn))) ||
                       (rEn && (o.includes(rEn) || rEn.includes(o)));
            }

            async function analyzeOrders() {
                document.getElementById("analyzeBtn").disabled = true;
                document.getElementById("errorBox").classList.add("hidden");
                document.getElementById("statusLog").innerHTML = "";
                document.getElementById("resultsContainer").innerHTML = "";

                try {
                    // Check if data is loaded (either from file or Google Sheets)
                    if (!ratesData || !ordersData) {
                        if (isLoadingRates || isLoadingOrders) {
                            throw new Error("Still loading data from Google Sheets. Please wait a moment and try again.");
                        }
                        throw new Error("Please provide both shipping rates and orders data (via upload or Google Sheets)");
                    }

                    const exchangeRate = parseFloat(document.getElementById("exchangeRate").value);
                    if (isNaN(exchangeRate) || exchangeRate <= 0) throw new Error("Invalid exchange rate");

                    updateProgress(5, "‚ö° Parsing Rate Sheet", "Using JavaScript - instant!");
                    addStatusLog(`Rate sheet: ${ratesData.length} rows, Orders: ${ordersData.length} rows`);

                    let shippingLineName = ratesData[1][0] ? String(ratesData[1][0]).trim() : "";
                    addStatusLog(`Found shipping line: ${shippingLineName}`);

                    let shippingLineNameEn = shippingLineName;
                    if (containsChinese(shippingLineName)) {
                        updateProgress(10, "üåê Translating Chinese", "Translating shipping carrier name...");
                        addStatusLog(`Detected Chinese in shipping line name, translating...`);
                        shippingLineNameEn = await translateChinese(shippingLineName);
                        addStatusLog(`Translation: "${shippingLineName}" ‚Üí "${shippingLineNameEn}"`, "success");
                    }

                    const ratesByCountry = {};
                    const countryMapping = {};
                    let currentCountry = null;

                    for (let i = 2; i < ratesData.length; i++) {
                        const row = ratesData[i];
                        if (!row || row.length < 6) continue;

                        if (row[0] && typeof row[0] === 'string' && row[0].trim()) {
                            currentCountry = row[0].trim();
                            const normalized = currentCountry.toUpperCase();
                            ratesByCountry[normalized] = [];
                            countryMapping[normalized] = currentCountry;
                        }

                        const weightRange = row[2];
                        const costPerKg = row[5];
                        const regFee = row[6];

                        if (currentCountry && weightRange && costPerKg) {
                            const weights = parseWeightRange(weightRange);
                            if (weights) {
                                const normalized = currentCountry.toUpperCase();
                                ratesByCountry[normalized].push({
                                    minWeight: weights.minWeight,
                                    maxWeight: weights.maxWeight,
                                    costPerKg: parseFloat(costPerKg),
                                    regFee: parseFloat(regFee) || 0,
                                    details: `${weights.minWeight}-${weights.maxWeight}kg @ ¬•${costPerKg}/kg + ¬•${regFee || 0} reg`
                                });
                            }
                        }
                    }

                    const totalCountries = Object.keys(ratesByCountry).length;
                    const totalBrackets = Object.values(ratesByCountry).reduce((s, b) => s + b.length, 0);

                    updateProgress(20, "‚úÖ Rate Sheet Parsed", `${totalCountries} countries, ${totalBrackets} brackets`);
                    addStatusLog(`‚úÖ Parsed ${totalCountries} countries with ${totalBrackets} rate brackets`, "success");

                    if (totalBrackets === 0) {
                        throw new Error("No rate brackets found in rate sheet");
                    }

                    updateProgress(25, "ü§ñ AI Detecting Columns", "One quick AI call...");
                    addStatusLog("ü§ñ Using AI to detect order columns...");

                    const orderSample = ordersData.slice(0, 3).map(r => r.join("|")).join("\n");
                    const colPrompt = `Identify column indices (0-based) in this data:
${orderSample}

Return ONLY JSON: {"orderIdCol":0,"countryCol":1,"weightCol":2,"cnyCostCol":3,"usdCostCol":4,"shippingLineCol":5}`;

                    const colResponse = await callOpenAI(colPrompt);
                    const colMap = extractJSON(colResponse);

                    updateProgress(40, "‚úÖ Columns Detected", "AI analysis complete");
                    addStatusLog(`‚úÖ Detected columns`, "success");

                    updateProgress(45, "üìä Parsing Orders", "Extracting all order data...");
                    addStatusLog("üìä Parsing orders with JavaScript...");

                    const allOrders = [];
                    for (let i = 1; i < ordersData.length; i++) {
                        const row = ordersData[i];
                        if (!row || !row[colMap.orderIdCol]) continue;

                        allOrders.push({
                            orderId: String(row[colMap.orderIdCol] || "").trim(),
                            country: String(row[colMap.countryCol] || "").trim(),
                            totalWeight: parseFloat(row[colMap.weightCol]) || 0,
                            chargedCNY: parseFloat(row[colMap.cnyCostCol]) || 0,
                            chargedUSD: parseFloat(row[colMap.usdCostCol]) || 0,
                            shippingLine: String(row[colMap.shippingLineCol] || "").trim(),
                        });
                    }

                    updateProgress(50, "‚úÖ Orders Parsed", `${allOrders.length} orders ready`);
                    addStatusLog(`‚úÖ Parsed ${allOrders.length} valid orders`, "success");

                    updateProgress(55, "‚ö° Matching Orders", "Processing at high speed...");

                    const results = { overcharge: [], undercharge: [], accurate: [], invalid: [], missingCarriers: [] };
                    const total = allOrders.length;
                    const missingCarrierMap = new Map();
                    const translationCache = new Map();

                    for (let i = 0; i < total; i++) {
                        const order = allOrders[i];

                        if (i % 100 === 0) {
                            const percent = 55 + (i / total) * 40;
                            updateProgress(percent, "‚ö° Processing", `${i}/${total} orders`);
                        }

                        let orderShippingLineEn = order.shippingLine;
                        if (containsChinese(order.shippingLine)) {
                            if (translationCache.has(order.shippingLine)) {
                                orderShippingLineEn = translationCache.get(order.shippingLine);
                            } else {
                                orderShippingLineEn = await translateChinese(order.shippingLine);
                                translationCache.set(order.shippingLine, orderShippingLineEn);
                            }
                        }

                        if (!matchShippingLine(order.shippingLine, shippingLineName, orderShippingLineEn, shippingLineNameEn)) {
                            const carrierKey = containsChinese(order.shippingLine) ?
                                `${order.shippingLine} (${orderShippingLineEn})` :
                                order.shippingLine;

                            if (!missingCarrierMap.has(carrierKey)) {
                                missingCarrierMap.set(carrierKey, []);
                            }
                            missingCarrierMap.get(carrierKey).push(order.orderId);

                            const rateCarrierDisplay = containsChinese(shippingLineName) ?
                                `${shippingLineName} (${shippingLineNameEn})` :
                                shippingLineName;

                            results.invalid.push({
                                ...order,
                                reason: `Shipping carrier/method mismatch`,
                                details: `Order uses "${carrierKey}" which doesn't match "${rateCarrierDisplay}"`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }

                        const normalizedCountry = order.country.toUpperCase();
                        const countryRates = ratesByCountry[normalizedCountry];
                        if (!countryRates || countryRates.length === 0) {
                            let errorReason, errorDetails;
                            if (!order.country || order.country.trim() === "") {
                                errorReason = "Missing country information";
                                errorDetails = "No country specified";
                            } else {
                                errorReason = `Country "${order.country}" not found`;
                                errorDetails = `No rates available for ${order.country}`;
                            }
                            results.invalid.push({
                                ...order,
                                reason: errorReason,
                                details: errorDetails,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }

                        const bracket = countryRates.find(b => order.totalWeight > b.minWeight && order.totalWeight <= b.maxWeight);
                        if (!bracket) {
                            const availableRanges = countryRates.map(b => `${b.minWeight}-${b.maxWeight}kg`).join(', ');
                            results.invalid.push({
                                ...order,
                                reason: `Weight ${order.totalWeight}kg out of range`,
                                details: `Available ranges: ${availableRanges}`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }

                        const expectedCNY = (order.totalWeight * bracket.costPerKg) + bracket.regFee;
                        const expectedUSD = expectedCNY / exchangeRate;
                        const difference = order.chargedUSD - expectedUSD;

                        const processed = {
                            ...order,
                            expectedCNY: expectedCNY.toFixed(2),
                            expectedUSD: expectedUSD.toFixed(2),
                            difference: difference.toFixed(2),
                            exchangeRate: exchangeRate,
                            bracket: bracket.details,
                        };

                        if (Math.abs(difference) < 0.01) results.accurate.push(processed);
                        else if (difference > 0) results.overcharge.push(processed);
                        else results.undercharge.push(processed);
                    }

                    results.missingCarriers = Array.from(missingCarrierMap.entries()).map(([carrier, orderIds]) => ({
                        carrier: carrier,
                        orderCount: orderIds.length,
                        orderIds: orderIds
                    }));

                    updateProgress(100, "‚úÖ Complete!", "All orders processed");
                    addStatusLog(`‚úÖ Analysis complete!`, "success");

                    setTimeout(() => {
                        document.getElementById("progressContainer").classList.add("hidden");
                        displayResults(results);
                    }, 1000);

                } catch (error) {
                    showError(error.message);
                    addStatusLog(`‚ùå Error: ${error.message}`, "error");
                    updateProgress(0, "‚ùå Error", error.message);
                } finally {
                    document.getElementById("analyzeBtn").disabled = false;
                }
            }

            function displayResults(results) {
                const container = document.getElementById("resultsContainer");
                document.getElementById("shareBtn").classList.remove("hidden");

                const overchargeTotal = results.overcharge.reduce((s, o) => s + parseFloat(o.difference), 0);
                const underchargeTotal = Math.abs(results.undercharge.reduce((s, o) => s + parseFloat(o.difference), 0));
                const totalOrders = results.overcharge.length + results.undercharge.length + results.accurate.length + results.invalid.length;
                const accurateOrders = results.accurate.length;
                const accuracyPercentage = totalOrders > 0 ? ((accurateOrders / totalOrders) * 100).toFixed(1) : 0;

                const top10Overcharged = [...results.overcharge]
                    .sort((a, b) => parseFloat(b.difference) - parseFloat(a.difference))
                    .slice(0, 10);

                const countryCounts = {};
                results.overcharge.forEach(o => {
                    countryCounts[o.country] = (countryCounts[o.country] || 0) + 1;
                });
                const topCountries = Object.entries(countryCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const invalidByReason = {};
                results.invalid.forEach(o => {
                    const reason = o.reason;
                    if (!invalidByReason[reason]) {
                        invalidByReason[reason] = [];
                    }
                    if (invalidByReason[reason].length < 3) {
                        invalidByReason[reason].push(o);
                    }
                });

                window.resultsData = results;

                container.innerHTML = `
                    <!-- Summary Cards -->
                    <div class="results-grid">
                        <div class="result-card">
                            <div class="result-icon" style="background: #fee2e2; color: #dc2626;">üìà</div>
                            <h3 style="font-size: 0.875rem; font-weight: 600; color: #64748b;">Overcharged</h3>
                            <div class="result-amount" style="color: #dc2626;">$${overchargeTotal.toFixed(2)}</div>
                            <div class="result-label">${results.overcharge.length} orders</div>
                            <button class="download-btn" onclick="downloadExcel('overcharge')">üì• Download Excel</button>
                        </div>
                        <div class="result-card">
                            <div class="result-icon" style="background: #d1fae5; color: #059669;">üìâ</div>
                            <h3 style="font-size: 0.875rem; font-weight: 600; color: #64748b;">Undercharged</h3>
                            <div class="result-amount" style="color: #059669;">$${underchargeTotal.toFixed(2)}</div>
                            <div class="result-label">${results.undercharge.length} orders</div>
                            <button class="download-btn" onclick="downloadExcel('undercharge')">üì• Download Excel</button>
                        </div>
                        <div class="result-card">
                            <div class="result-icon" style="background: #dbeafe; color: #3b82f6;">‚úì</div>
                            <h3 style="font-size: 0.875rem; font-weight: 600; color: #64748b;">Accurate</h3>
                            <div class="result-amount" style="color: #3b82f6;">${results.accurate.length}</div>
                            <div class="result-label">correctly charged</div>
                            <button class="download-btn" onclick="downloadExcel('accurate')">üì• Download Excel</button>
                        </div>
                        <div class="result-card">
                            <div class="result-icon" style="background: #f3f4f6; color: #6b7280;">‚ö†</div>
                            <h3 style="font-size: 0.875rem; font-weight: 600; color: #64748b;">Invalid</h3>
                            <div class="result-amount" style="color: #6b7280;">${results.invalid.length}</div>
                            <div class="result-label">orders with issues</div>
                            <button class="download-btn" onclick="downloadExcel('invalid')">üì• Download Excel</button>
                        </div>
                    </div>

                    <!-- All Orders Detailed View -->
                    <div class="card">
                        <h2>üìä All Orders - Detailed View</h2>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                            <button onclick="switchTab('overcharge')" id="tab-overcharge" class="tab-btn active">
                                Overcharged (${results.overcharge.length})
                            </button>
                            <button onclick="switchTab('undercharge')" id="tab-undercharge" class="tab-btn">
                                Undercharged (${results.undercharge.length})
                            </button>
                            <button onclick="switchTab('accurate')" id="tab-accurate" class="tab-btn">
                                Accurate (${results.accurate.length})
                            </button>
                            <button onclick="switchTab('invalid')" id="tab-invalid" class="tab-btn">
                                Invalid (${results.invalid.length})
                            </button>
                        </div>
                        <div class="tab-content" id="content-overcharge" style="display: block;">
                            ${generateOrderTable(results.overcharge, 'overcharge')}
                        </div>
                        <div class="tab-content" id="content-undercharge" style="display: none;">
                            ${generateOrderTable(results.undercharge, 'undercharge')}
                        </div>
                        <div class="tab-content" id="content-accurate" style="display: none;">
                            ${generateOrderTable(results.accurate, 'accurate')}
                        </div>
                        <div class="tab-content" id="content-invalid" style="display: none;">
                            ${generateOrderTable(results.invalid, 'invalid')}
                        </div>
                    </div>

                    <!-- Overall Accuracy -->
                    <div class="card" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 1px solid #93c5fd;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: #1e40af;">Overall Accuracy</h2>
                                <p style="color: #1e40af; font-size: 0.875rem;">${accurateOrders} out of ${totalOrders} orders correctly charged</p>
                            </div>
                            <div style="font-size: 3rem; font-weight: 800; color: #3b82f6;">${accuracyPercentage}%</div>
                        </div>
                    </div>

                    ${top10Overcharged.length > 0 ? `
                    <div class="card">
                        <h2>üî• Top 10 Overcharged Orders</h2>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Country</th>
                                        <th style="text-align: right;">Weight (kg)</th>
                                        <th style="text-align: right;">Charged (USD)</th>
                                        <th style="text-align: right;">Expected (USD)</th>
                                        <th style="text-align: right;">Overcharge</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${top10Overcharged.map(order => `
                                        <tr>
                                            <td style="font-weight: 600; color: #3b82f6;">${order.orderId}</td>
                                            <td>${order.country}</td>
                                            <td style="text-align: right;">${order.totalWeight}</td>
                                            <td style="text-align: right;">$${order.chargedUSD}</td>
                                            <td style="text-align: right;">$${order.expectedUSD}</td>
                                            <td style="text-align: right; font-weight: 600; color: #dc2626;">+$${order.difference}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    ${topCountries.length > 0 ? `
                    <div class="card">
                        <h2>üåç Overcharges by Country</h2>
                        <div style="display: grid; gap: 0.75rem;">
                            ${topCountries.map(([country, count]) => {
                                const countryTotal = results.overcharge
                                    .filter(o => o.country === country)
                                    .reduce((sum, o) => sum + parseFloat(o.difference), 0);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                                        <div>
                                            <div style="font-weight: 600; color: #0f172a;">${country}</div>
                                            <div style="font-size: 0.875rem; color: #64748b;">${count} orders</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 700; font-size: 1.25rem; color: #dc2626;">$${countryTotal.toFixed(2)}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${results.invalid.length > 0 ? `
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion('invalid-orders')">
                            <div style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.125rem; font-weight: 700; color: #991b1b;">
                                <span>‚ö†Ô∏è</span>
                                <span>Invalid Orders (${results.invalid.length})</span>
                            </div>
                            <div style="font-size: 1.5rem; transition: transform 0.3s ease; color: #f59e0b;" id="chevron-invalid-orders">‚ñº</div>
                        </div>
                        <div class="accordion-content" id="content-invalid-orders">
                            ${generateOrderTable(results.invalid, 'invalid')}
                        </div>
                    </div>
                    ` : ''}

                    ${results.missingCarriers.length > 0 ? `
                    <div class="card" style="background: #fffbeb; border: 1px solid #fde68a;">
                        <h2 style="color: #92400e;">üì¶ Missing Shipping Carriers</h2>
                        <p style="color: #78350f; margin-bottom: 1rem; font-size: 0.875rem;">
                            ${results.missingCarriers.reduce((total, item) => total + item.orderCount, 0)} orders need rate sheets
                        </p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Carrier/Method</th>
                                        <th style="text-align: center;">Orders</th>
                                        <th>Sample Order IDs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.missingCarriers.map(item => `
                                        <tr>
                                            <td style="font-weight: 600;">${item.carrier}</td>
                                            <td style="text-align: center; font-weight: 700; color: #d97706;">${item.orderCount}</td>
                                            <td style="font-size: 0.813rem; color: #64748b;">${item.orderIds.slice(0, 5).join(', ')}${item.orderIds.length > 5 ? '...' : ''}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}
                `;
            }

            function generateOrderTable(orders, type) {
                if (orders.length === 0) {
                    return `<p style="color: #94a3b8; text-align: center; padding: 2rem;">No ${type} orders</p>`;
                }

                const isInvalid = type === 'invalid';

                return `
                    <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Country</th>
                                <th style="text-align: right;">Weight (kg)</th>
                                <th style="text-align: right;">Charged (USD)</th>
                                ${!isInvalid ? `
                                    <th style="text-align: right;">Expected (USD)</th>
                                    <th style="text-align: right;">Difference</th>
                                ` : `
                                    <th>Shipping Carrier</th>
                                    <th>Issue</th>
                                `}
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td style="font-weight: 600; color: #3b82f6;">${order.orderId}</td>
                                    <td>${order.country}</td>
                                    <td style="text-align: right;">${order.totalWeight}</td>
                                    <td style="text-align: right;">$${order.chargedUSD}</td>
                                    ${!isInvalid ? `
                                        <td style="text-align: right;">$${order.expectedUSD}</td>
                                        <td style="text-align: right; font-weight: 600; color: ${parseFloat(order.difference) > 0 ? '#dc2626' : '#059669'};">
                                            ${parseFloat(order.difference) > 0 ? '+' : ''}$${order.difference}
                                        </td>
                                    ` : `
                                        <td>${order.shippingLine}</td>
                                        <td style="color: #dc2626; font-weight: 600; font-size: 0.813rem;">${order.reason}</td>
                                    `}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    </div>
                `;
            }

            function toggleAccordion(id) {
                const content = document.getElementById(`content-${id}`);
                const chevron = document.getElementById(`chevron-${id}`);
                const isOpen = content.classList.contains('open');

                if (isOpen) {
                    content.classList.remove('open');
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('open');
                    chevron.style.transform = 'rotate(180deg)';
                }
            }

            function switchTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`content-${tabName}`).style.display = 'block';
                document.getElementById(`tab-${tabName}`).classList.add('active');
            }

            async function downloadExcel(type) {
                const data = window.resultsData[type];
                if (!data || !data.length) {
                    alert("No data available");
                    return;
                }

                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet(type.charAt(0).toUpperCase() + type.slice(1));

                const colors = {
                    overcharge: { header: 'FFDC2626', row: 'FFFEE2E2' },
                    undercharge: { header: 'FF059669', row: 'FFD1FAE5' },
                    accurate: { header: 'FF3B82F6', row: 'FFDBEAFE' },
                    invalid: { header: 'FF6B7280', row: 'FFF3F4F6' }
                };

                const isInvalid = type === 'invalid';
                const headers = isInvalid
                    ? ['Order ID', 'Country', 'Weight (kg)', 'Charged USD', 'Shipping Carrier', 'Issue', 'Details']
                    : ['Order ID', 'Country', 'Weight (kg)', 'Charged USD', 'Expected USD', 'Difference USD', 'Bracket'];

                const headerRow = worksheet.addRow(headers);
                headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
                headerRow.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: colors[type].header }
                };
                headerRow.height = 25;
                headerRow.alignment = { vertical: 'middle', horizontal: 'center' };

                let totalCharged = 0, totalExpected = 0, totalDiff = 0;

                data.forEach((order, idx) => {
                    const rowData = isInvalid
                        ? [order.orderId, order.country, order.totalWeight, order.chargedUSD, order.shippingLine, order.reason, order.details]
                        : [order.orderId, order.country, order.totalWeight, order.chargedUSD, order.expectedUSD, order.difference, order.bracket];

                    const row = worksheet.addRow(rowData);

                    if (idx % 2 === 0) {
                        row.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: colors[type].row }
                        };
                    }

                    if (!isInvalid && order.expectedUSD !== "N/A") {
                        totalCharged += parseFloat(order.chargedUSD);
                        totalExpected += parseFloat(order.expectedUSD);
                        totalDiff += parseFloat(order.difference);
                    }
                });

                if (!isInvalid) {
                    worksheet.addRow([]);
                    const totalRow = worksheet.addRow(['TOTAL', '', '', totalCharged.toFixed(2), totalExpected.toFixed(2), totalDiff.toFixed(2), '']);
                    totalRow.font = { bold: true };
                }

                worksheet.columns.forEach((col, idx) => {
                    col.width = idx === 6 ? 30 : 15;
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}_orders.xlsx`;
                a.click();
                URL.revokeObjectURL(url);
            }

            async function shareDashboard(event) {
                if (!window.resultsData) {
                    alert("No results to share");
                    return;
                }

                const btn = event.target;
                const originalText = btn.innerHTML;

                try {
                    btn.innerHTML = '‚è≥ Creating link...';
                    btn.disabled = true;

                    // Store data using dpaste.com API
                    const response = await fetch('https://dpaste.com/api/v2/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            content: JSON.stringify(window.resultsData),
                            syntax: 'json',
                            expiry_days: 365
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create share link');
                    }

                    const pasteUrl = await response.text();
                    const pasteId = pasteUrl.trim().split('/').filter(p => p).pop();

                    // Create shareable URL with short ID
                    const baseUrl = window.location.href.split('?')[0].split('#')[0];
                    const shareUrl = `${baseUrl}?share=${pasteId}`;

                    // Copy to clipboard
                    await navigator.clipboard.writeText(shareUrl);

                    btn.innerHTML = '‚úÖ Copied!';
                    btn.style.background = '#10b981';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#3b82f6';
                        btn.disabled = false;
                    }, 3000);

                } catch (error) {
                    console.error('Error creating link:', error);
                    btn.innerHTML = '‚ùå Failed';
                    btn.style.background = '#ef4444';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#3b82f6';
                        btn.disabled = false;
                    }, 3000);

                    alert('Failed to create share link. Please try again.');
                }
            }

            async function loadResultsFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                const shareId = urlParams.get('share');

                if (!shareId) return;

                try {
                    // Show loading message
                    const container = document.getElementById('resultsContainer');
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                            <div style="font-size: 1.2rem; color: #64748b;">Loading shared dashboard...</div>
                        </div>
                    `;

                    // Fetch data from dpaste
                    const response = await fetch(`https://dpaste.com/${shareId}.txt`);

                    if (!response.ok) {
                        throw new Error('Snapshot not found');
                    }

                    const dataStr = await response.text();
                    const results = JSON.parse(dataStr);

                    window.resultsData = results;
                    displayResults(results);

                    // Hide input section
                    document.getElementById('inputSection').style.display = 'none';
                } catch (error) {
                    console.error('Failed to load snapshot:', error);
                    const container = document.getElementById('resultsContainer');
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 3rem;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>
                            <div style="font-size: 1.2rem; color: #ef4444; margin-bottom: 1rem;">Failed to load shared dashboard</div>
                            <div style="color: #64748b;">The link may be invalid or expired.</div>
                        </div>
                    `;
                }
            }
        </script>
    </body>
</html>
