<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PuppyPad Shipping Auditor</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #f3e7ff 0%, #e0f2fe 100%);
                min-height: 100vh;
                padding: 2rem;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            .card {
                background: white;
                border-radius: 1rem;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                padding: 2rem;
                margin-bottom: 1.5rem;
            }
            .header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 2rem;
            }
            .icon {
                width: 3rem;
                height: 3rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                border-radius: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.5rem;
            }
            h1 {
                font-size: 2rem;
                color: #1f2937;
            }
            .subtitle {
                color: #6b7280;
                font-size: 0.875rem;
            }
            .form-group {
                margin-bottom: 1.5rem;
            }
            label {
                display: block;
                font-weight: 500;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
            }
            input[type="number"] {
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                font-size: 1rem;
                transition: border-color 0.2s;
            }
            input:focus {
                outline: none;
                border-color: #8b5cf6;
            }
            .file-upload {
                border: 2px dashed #d1d5db;
                border-radius: 0.5rem;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: border-color 0.2s;
            }
            .file-upload:hover {
                border-color: #8b5cf6;
            }
            .file-upload.has-file {
                border-color: #8b5cf6;
                background: #f3e7ff;
            }
            .file-name {
                color: #8b5cf6;
                font-weight: 500;
            }
            button {
                width: 100%;
                padding: 1rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                color: white;
                border: none;
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            button:hover:not(:disabled) {
                opacity: 0.9;
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .console-log {
                background: #1f2937;
                color: #9ca3af;
                border: 2px solid #374151;
                border-radius: 0.5rem;
                padding: 1rem;
                max-height: 300px;
                overflow-y: auto;
                font-family: "Courier New", monospace;
                font-size: 0.75rem;
                margin: 1rem 0;
            }
            .console-line {
                margin-bottom: 0.25rem;
            }
            .console-time {
                color: #6b7280;
            }
            .console-success {
                color: #10b981;
            }
            .console-error {
                color: #ef4444;
            }
            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                margin-top: 1.5rem;
            }
            .result-card {
                background: white;
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .result-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .result-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
            }
            .result-amount {
                font-size: 1.75rem;
                font-weight: bold;
                margin: 0.5rem 0;
            }
            .download-btn {
                padding: 0.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: background 0.2s;
                width: auto;
            }
            .error-box {
                background: #fef2f2;
                border: 2px solid #fecaca;
                color: #991b1b;
                padding: 1rem;
                border-radius: 0.5rem;
                margin: 1rem 0;
            }
            .hidden {
                display: none;
            }
            .progress-box {
                background: #f3e7ff;
                border: 2px solid #e0d5f7;
                padding: 1.5rem;
                border-radius: 0.5rem;
                margin: 1rem 0;
            }
            .progress-text {
                font-weight: 600;
                color: #7c3aed;
                margin-bottom: 0.5rem;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <div class="header">
                    <div class="icon">ü§ñ</div>
                    <div>
                        <h1>PuppyPad Shipping Auditor</h1>
                        <div class="subtitle">
                            ü§ñ AI-Powered - Let GPT-4o-mini Do All The Work
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Shipping Line Charges Excel File</label>
                    <div class="file-upload" id="ratesUpload" onclick="document.getElementById('ratesFile').click()">
                        <span id="ratesLabel">üìÅ Click to upload Excel file</span>
                    </div>
                    <input type="file" id="ratesFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('rates')" />
                </div>
                <div class="form-group">
                    <label>Exchange Rate (CNY to USD)</label>
                    <input type="number" id="exchangeRate" value="6.9" step="0.01" />
                </div>
                <div class="form-group">
                    <label>Mrek Orders Excel File</label>
                    <div class="file-upload" id="ordersUpload" onclick="document.getElementById('ordersFile').click()">
                        <span id="ordersLabel">üìÅ Click to upload Excel file</span>
                    </div>
                    <input type="file" id="ordersFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('orders')" />
                </div>
                <div id="errorBox" class="error-box hidden"></div>
                <div id="consoleBox" class="console-log hidden">
                    <div style="border-bottom: 1px solid #374151; padding-bottom: 0.5rem; margin-bottom: 0.5rem; color: #d1d5db;">
                        AI Progress
                    </div>
                    <div id="consoleContent"></div>
                </div>
                <div id="progressBox" class="progress-box hidden">
                    <div class="progress-text" id="progressText">Initializing...</div>
                </div>
                <button id="analyzeBtn" onclick="analyzeOrders()">
                    ü§ñ Let AI Analyze Everything
                </button>
            </div>
            <div id="resultsContainer" class="hidden"></div>
        </div>
        <script>
            let ratesData = null;
            let ordersData = null;
            
            function handleFileSelect(type) {
                const input = document.getElementById(type + "File");
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1,
                        defval: "",
                    });
                    if (type === "rates") {
                        ratesData = jsonData;
                        document.getElementById("ratesUpload").classList.add("has-file");
                        document.getElementById("ratesLabel").innerHTML = `<span class="file-name">${file.name}</span>`;
                    } else {
                        ordersData = jsonData;
                        document.getElementById("ordersUpload").classList.add("has-file");
                        document.getElementById("ordersLabel").innerHTML = `<span class="file-name">${file.name}</span>`;
                    }
                    addConsoleLog(`‚úÖ Loaded ${jsonData.length} rows from ${file.name}`, "success");
                };
                reader.readAsArrayBuffer(file);
            }
            
            function addConsoleLog(message, type = "info") {
                const consoleBox = document.getElementById("consoleBox");
                const consoleContent = document.getElementById("consoleContent");
                consoleBox.classList.remove("hidden");
                const time = new Date().toLocaleTimeString();
                const colorClass = type === "error" ? "console-error" : type === "success" ? "console-success" : "";
                consoleContent.innerHTML += `<div class="console-line"><span class="console-time">${time}</span> <span class="${colorClass}">${message}</span></div>`;
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }
            
            function showError(message) {
                document.getElementById("errorBox").textContent = message;
                document.getElementById("errorBox").classList.remove("hidden");
            }
            
            function setProgress(message) {
                document.getElementById("progressBox").classList.remove("hidden");
                document.getElementById("progressText").textContent = message;
            }
            
            async function callOpenAI(prompt) {
                const response = await fetch("/api/openai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "system",
                                content: "You are a shipping cost auditor. Analyze data and return ONLY valid JSON with no markdown formatting."
                            },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0,
                        max_tokens: 16000,
                    }),
                });
                
                if (!response.ok) {
                    throw new Error(`OpenAI API failed: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error("Invalid response from OpenAI");
                }
                
                return data.choices[0].message.content;
            }
            
            function extractJSON(text) {
                let cleaned = text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                const match = cleaned.match(/\{[\s\S]*\}/);
                if (match) cleaned = match[0];
                return JSON.parse(cleaned.replace(/[""]/g, '"').replace(/['']/g, "'"));
            }
            
            async function analyzeOrders() {
                document.getElementById("analyzeBtn").disabled = true;
                document.getElementById("errorBox").classList.add("hidden");
                document.getElementById("consoleContent").innerHTML = "";
                document.getElementById("resultsContainer").innerHTML = "";
                document.getElementById("resultsContainer").classList.add("hidden");
                
                try {
                    if (!ratesData || !ordersData) {
                        throw new Error("Please upload both Excel files");
                    }
                    
                    const rate = parseFloat(document.getElementById("exchangeRate").value);
                    if (isNaN(rate) || rate <= 0) {
                        throw new Error("Invalid exchange rate");
                    }
                    
                    setProgress("ü§ñ AI is analyzing both files...");
                    addConsoleLog("ü§ñ Sending data to GPT-4o-mini for complete analysis...");
                    
                    // Convert data to text for AI
                    const ratesText = ratesData.slice(0, 150).map(row => row.join("|")).join("\n");
                    const ordersText = ordersData.slice(0, 100).map(row => row.join("|")).join("\n");
                    
                    const prompt = `You are analyzing shipping costs. I have two files:

RATE SHEET (first 150 rows):
${ratesText}

ORDERS (first 100 rows):
${ordersText}

TASK:
1. Understand the rate sheet structure (it has shipping line name, countries, weight brackets, costs per kg, registration fees)
2. Understand the orders structure (order ID, country, weight, shipping line, charged CNY, charged USD)
3. For each order:
   - Match it to the correct shipping line (ignore prefixes like "‰∫ëÈÄî-", use fuzzy matching on Chinese/English names)
   - Match it to the correct country's rates
   - Find the weight bracket
   - Calculate expected cost: (weight √ó cost_per_kg) + registration_fee
   - Convert CNY to USD using exchange rate: ${rate}
   - Compare charged USD vs expected USD
   - Categorize as: overcharge (charged > expected), undercharge (charged < expected), accurate (same), or invalid (can't match)

Return ONLY this JSON (no markdown, no explanation):
{
  "overcharge": [{"orderId":"123","country":"US","totalWeight":0.5,"chargedCNY":100,"chargedUSD":14.49,"expectedCNY":95,"expectedUSD":13.77,"difference":0.72,"exchangeRate":${rate},"bracket":"0.45-0.7kg @ ¬•90/kg + ¬•20 reg","shippingLine":"‰∫ëÈÄî..."}],
  "undercharge": [...],
  "accurate": [...],
  "invalid": [{"orderId":"456","country":"UK","totalWeight":0.5,"chargedCNY":100,"chargedUSD":14.49,"reason":"No rate bracket found","expectedCNY":"N/A","expectedUSD":"N/A","difference":"N/A","bracket":"N/A","shippingLine":"..."}]
}

IMPORTANT:
- Include ALL orders from the orders file (parse the entire file, not just sample)
- Use fuzzy matching for shipping line names
- Match by destination country
- Calculate: total_cny = (weight √ó rate_per_kg) + registration_fee
- Be precise with calculations
- Return ONLY the JSON object, no other text`;

                    addConsoleLog("‚è≥ Waiting for AI response (this may take 30-60 seconds)...");
                    const aiResponse = await callOpenAI(prompt);
                    
                    addConsoleLog("‚úÖ AI analysis complete! Parsing results...");
                    const results = extractJSON(aiResponse);
                    
                    addConsoleLog(`‚úÖ Found: ${results.overcharge.length} overcharged, ${results.undercharge.length} undercharged, ${results.accurate.length} accurate, ${results.invalid.length} invalid`, "success");
                    
                    displayResults(results);
                    
                } catch (error) {
                    showError(error.message);
                    addConsoleLog(`‚ùå Error: ${error.message}`, "error");
                } finally {
                    document.getElementById("analyzeBtn").disabled = false;
                    document.getElementById("progressBox").classList.add("hidden");
                }
            }
            
            function displayResults(results) {
                const container = document.getElementById("resultsContainer");
                container.classList.remove("hidden");
                
                const overchargeTotal = results.overcharge.reduce((sum, o) => sum + parseFloat(o.difference || 0), 0);
                const underchargeTotal = Math.abs(results.undercharge.reduce((sum, o) => sum + parseFloat(o.difference || 0), 0));
                
                window.resultsData = results;
                
                container.innerHTML = `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #fee2e2; color: #dc2626;">üìà</div>
                            <button class="download-btn" onclick="downloadCSV('overcharge')" style="background: #fee2e2; color: #dc2626;">üíæ</button>
                        </div>
                        <h3>Overcharged</h3>
                        <div class="result-amount" style="color: #dc2626;">$${overchargeTotal.toFixed(2)}</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.overcharge.length} orders</div>
                    </div>
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #d1fae5; color: #059669;">üìâ</div>
                            <button class="download-btn" onclick="downloadCSV('undercharge')" style="background: #d1fae5; color: #059669;">üíæ</button>
                        </div>
                        <h3>Undercharged</h3>
                        <div class="result-amount" style="color: #059669;">$${underchargeTotal.toFixed(2)}</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.undercharge.length} orders</div>
                    </div>
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #dbeafe; color: #2563eb;">‚úì</div>
                            <button class="download-btn" onclick="downloadCSV('accurate')" style="background: #dbeafe; color: #2563eb;">üíæ</button>
                        </div>
                        <h3>Accurate</h3>
                        <div class="result-amount" style="color: #2563eb;">100%</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.accurate.length} orders</div>
                    </div>
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #f3f4f6; color: #6b7280;">‚ö†</div>
                            <button class="download-btn" onclick="downloadCSV('invalid')" style="background: #f3f4f6; color: #6b7280;">üíæ</button>
                        </div>
                        <h3>Invalid</h3>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">${results.invalid.length} orders</div>
                    </div>
                </div>
            `;
            }
            
            function downloadCSV(type) {
                const data = window.resultsData[type];
                if (!data || data.length === 0) {
                    alert("No data to download");
                    return;
                }
                
                const headers = [
                    "Order ID",
                    "Country",
                    "Total Weight (kg)",
                    "Charged CNY",
                    "Charged USD",
                    "Expected CNY",
                    "Expected USD",
                    "Exchange Rate",
                    "Difference USD",
                    "Weight Bracket",
                    "Shipping Line",
                    data[0].reason ? "Reason" : "",
                ].filter(Boolean);
                
                let csv = headers.join(",") + "\n";
                let totalChargedCNY = 0, totalChargedUSD = 0, totalExpectedCNY = 0, totalExpectedUSD = 0, totalDifference = 0;
                
                data.forEach((order) => {
                    const row = [
                        order.orderId,
                        order.country || "",
                        order.totalWeight,
                        order.chargedCNY,
                        order.chargedUSD,
                        order.expectedCNY,
                        order.expectedUSD,
                        order.exchangeRate || "",
                        order.difference,
                        `"${order.bracket}"`,
                        order.shippingLine,
                        order.reason || "",
                    ].filter((_, i) => i < headers.length);
                    csv += row.join(",") + "\n";
                    
                    if (order.expectedCNY !== "N/A") {
                        totalChargedCNY += parseFloat(order.chargedCNY) || 0;
                        totalChargedUSD += parseFloat(order.chargedUSD) || 0;
                        totalExpectedCNY += parseFloat(order.expectedCNY) || 0;
                        totalExpectedUSD += parseFloat(order.expectedUSD) || 0;
                        totalDifference += parseFloat(order.difference) || 0;
                    }
                });
                
                csv += "\n" + [
                    "TOTAL",
                    "",
                    "",
                    totalChargedCNY.toFixed(2),
                    totalChargedUSD.toFixed(2),
                    totalExpectedCNY.toFixed(2),
                    totalExpectedUSD.toFixed(2),
                    "",
                    totalDifference.toFixed(2),
                    "",
                    "",
                    "",
                ].slice(0, headers.length).join(",");
                
                const blob = new Blob([csv], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${type}_orders.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }
        </script>
    </body>
</html>
