<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PuppyPad Shipping Auditor</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: linear-gradient(135deg, #f3e7ff 0%, #e0f2fe 100%);
                min-height: 100vh;
                padding: 2rem;
            }
            .container { max-width: 1200px; margin: 0 auto; }
            .card {
                background: white;
                border-radius: 1rem;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
                padding: 2rem;
                margin-bottom: 1.5rem;
            }
            .header { display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; }
            .icon {
                width: 3rem; height: 3rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                border-radius: 0.75rem;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 1.5rem;
            }
            h1 { font-size: 2rem; color: #1f2937; }
            .subtitle { color: #6b7280; font-size: 0.875rem; }
            .form-group { margin-bottom: 1.5rem; }
            label {
                display: block;
                font-weight: 500;
                color: #374151;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
            }
            input[type="number"] {
                width: 100%;
                padding: 0.75rem;
                border: 2px solid #e5e7eb;
                border-radius: 0.5rem;
                font-size: 1rem;
                transition: border-color 0.2s;
            }
            input:focus { outline: none; border-color: #8b5cf6; }
            .file-upload {
                border: 2px dashed #d1d5db;
                border-radius: 0.5rem;
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: border-color 0.2s;
            }
            .file-upload:hover { border-color: #8b5cf6; }
            .file-upload.has-file { border-color: #8b5cf6; background: #f3e7ff; }
            .file-name { color: #8b5cf6; font-weight: 500; }
            button {
                width: 100%;
                padding: 1rem;
                background: linear-gradient(135deg, #8b5cf6 0%, #3b82f6 100%);
                color: white;
                border: none;
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            button:hover:not(:disabled) { opacity: 0.9; }
            button:disabled { opacity: 0.5; cursor: not-allowed; }
            .progress-container {
                background: white;
                border-radius: 0.5rem;
                padding: 1.5rem;
                margin: 1rem 0;
                border: 2px solid #e0d5f7;
            }
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .progress-text { font-weight: 600; color: #7c3aed; font-size: 1rem; }
            .progress-percentage { font-weight: 700; color: #7c3aed; font-size: 1.5rem; }
            .progress-bar-container {
                width: 100%;
                height: 8px;
                background: #e0d5f7;
                border-radius: 999px;
                overflow: hidden;
                margin-bottom: 0.75rem;
            }
            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%);
                border-radius: 999px;
                transition: width 0.3s ease;
                width: 0%;
            }
            .progress-status { color: #6b7280; font-size: 0.875rem; }
            .status-log {
                background: #f9fafb;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
                max-height: 150px;
                overflow-y: auto;
                font-size: 0.813rem;
                font-family: monospace;
                margin-top: 1rem;
            }
            .status-line { margin-bottom: 0.25rem; color: #6b7280; }
            .status-line.success { color: #10b981; }
            .status-line.error { color: #ef4444; }
            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1.5rem;
                margin-top: 1.5rem;
            }
            .result-card {
                background: white;
                border-radius: 0.75rem;
                padding: 1.5rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            }
            .result-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
            }
            .result-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 0.5rem;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
            }
            .result-amount { font-size: 1.75rem; font-weight: bold; margin: 0.5rem 0; }
            .download-btn {
                padding: 0.5rem;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: background 0.2s;
                width: auto;
            }
            .error-box {
                background: #fef2f2;
                border: 2px solid #fecaca;
                color: #991b1b;
                padding: 1rem;
                border-radius: 0.5rem;
                margin: 1rem 0;
            }
            .hidden { display: none; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="card">
                <div class="header">
                    <div class="icon">‚ö°</div>
                    <div>
                        <h1>PuppyPad Shipping Auditor</h1>
                        <div class="subtitle">‚ö° Lightning Fast - 2 AI Calls + JavaScript</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Shipping Line Charges Excel File</label>
                    <div class="file-upload" id="ratesUpload" onclick="document.getElementById('ratesFile').click()">
                        <span id="ratesLabel">üìÅ Click to upload Excel file</span>
                    </div>
                    <input type="file" id="ratesFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('rates')" />
                </div>
                <div class="form-group">
                    <label>Exchange Rate (CNY to USD)</label>
                    <input type="number" id="exchangeRate" value="6.9" step="0.01" />
                </div>
                <div class="form-group">
                    <label>Mrek Orders Excel File</label>
                    <div class="file-upload" id="ordersUpload" onclick="document.getElementById('ordersFile').click()">
                        <span id="ordersLabel">üìÅ Click to upload Excel file</span>
                    </div>
                    <input type="file" id="ordersFile" accept=".xlsx,.xls" style="display: none" onchange="handleFileSelect('orders')" />
                </div>
                <div id="errorBox" class="error-box hidden"></div>
                <div id="progressContainer" class="progress-container hidden">
                    <div class="progress-header">
                        <div class="progress-text" id="progressText">Initializing...</div>
                        <div class="progress-percentage" id="progressPercent">0%</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-status" id="progressStatus">Preparing...</div>
                    <div class="status-log" id="statusLog"></div>
                </div>
                <button id="analyzeBtn" onclick="analyzeOrders()">‚ö° Analyze All Orders (Ultra Fast!)</button>
            </div>
            <div id="resultsContainer" class="hidden"></div>
        </div>
        <script>
            let ratesData = null, ordersData = null;
            
            function handleFileSelect(type) {
                const input = document.getElementById(type + "File");
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });
                    if (type === "rates") {
                        ratesData = jsonData;
                        document.getElementById("ratesUpload").classList.add("has-file");
                        document.getElementById("ratesLabel").innerHTML = `<span class="file-name">${file.name} (${jsonData.length} rows)</span>`;
                    } else {
                        ordersData = jsonData;
                        document.getElementById("ordersUpload").classList.add("has-file");
                        document.getElementById("ordersLabel").innerHTML = `<span class="file-name">${file.name} (${jsonData.length} rows)</span>`;
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            function updateProgress(percent, text, status) {
                document.getElementById("progressContainer").classList.remove("hidden");
                document.getElementById("progressBar").style.width = percent + "%";
                document.getElementById("progressPercent").textContent = Math.round(percent) + "%";
                document.getElementById("progressText").textContent = text;
                if (status) document.getElementById("progressStatus").textContent = status;
            }
            
            function addStatusLog(message, type = "info") {
                const log = document.getElementById("statusLog");
                const line = document.createElement("div");
                line.className = `status-line ${type}`;
                line.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
                log.appendChild(line);
                log.scrollTop = log.scrollHeight;
            }
            
            function showError(message) {
                document.getElementById("errorBox").textContent = message;
                document.getElementById("errorBox").classList.remove("hidden");
            }
            
            async function callOpenAI(prompt) {
                const response = await fetch("/api/openai", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            { role: "system", content: "Return ONLY valid JSON. No markdown, no explanation." },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0,
                        max_tokens: 8000,
                    }),
                });
                if (!response.ok) throw new Error(`API failed: ${response.status}`);
                const data = await response.json();
                if (!data.choices?.[0]?.message?.content) throw new Error("Invalid API response");
                return data.choices[0].message.content;
            }
            
            function extractJSON(text) {
                let cleaned = text.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                const match = cleaned.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                if (match) cleaned = match[0];
                return JSON.parse(cleaned);
            }
            
            function normalizeShippingLine(text) {
                return text ? text.toLowerCase().replace(/^[^-]+-/, '').replace(/\s+/g, '').replace(/[()ÔºàÔºâ]/g, '') : "";
            }
            
            function matchShippingLine(orderLine, rateLine) {
                const o = normalizeShippingLine(orderLine);
                const r = normalizeShippingLine(rateLine);
                return o.includes(r) || r.includes(o);
            }
            
            async function analyzeOrders() {
                document.getElementById("analyzeBtn").disabled = true;
                document.getElementById("errorBox").classList.add("hidden");
                document.getElementById("statusLog").innerHTML = "";
                document.getElementById("resultsContainer").innerHTML = "";
                document.getElementById("resultsContainer").classList.add("hidden");
                
                try {
                    if (!ratesData || !ordersData) throw new Error("Upload both files");
                    const exchangeRate = parseFloat(document.getElementById("exchangeRate").value);
                    if (isNaN(exchangeRate) || exchangeRate <= 0) throw new Error("Invalid exchange rate");
                    
                    updateProgress(5, "ü§ñ AI Parsing Rate Sheet", "Sending to AI...");
                    addStatusLog(`Rate sheet: ${ratesData.length} rows, Orders: ${ordersData.length} rows`);
                    
                    const ratesText = ratesData.map(row => row.join("|")).join("\n");
                    const ratePrompt = `Parse shipping rates. Extract:
1. Shipping line name (row 2)
2. ALL countries with ALL weight brackets

Data:
${ratesText}

Return JSON:
{"lineName":"...","countries":{"United States":[{"minWeight":0,"maxWeight":0.1,"costPerKg":100,"regFee":24,"details":"..."}]}}`;

                    addStatusLog("ü§ñ Calling OpenAI...");
                    const rateResponse = await callOpenAI(ratePrompt);
                    updateProgress(20, "‚úÖ Rates Parsed", "AI done");
                    const rateData = extractJSON(rateResponse);
                    
                    const totalCountries = Object.keys(rateData.countries).length;
                    const totalBrackets = Object.values(rateData.countries).reduce((s, b) => s + b.length, 0);
                    addStatusLog(`‚úÖ ${totalCountries} countries, ${totalBrackets} brackets`, "success");
                    
                    updateProgress(25, "ü§ñ Detecting Order Columns", "Quick AI call...");
                    const orderSample = ordersData.slice(0, 3).map(r => r.join("|")).join("\n");
                    const colPrompt = `Column indices (0-based):
${orderSample}

Return JSON: {"orderIdCol":0,"countryCol":1,"weightCol":2,"cnyCostCol":3,"usdCostCol":4,"shippingLineCol":5}`;
                    
                    const colResponse = await callOpenAI(colPrompt);
                    const colMap = extractJSON(colResponse);
                    updateProgress(30, "üìä Parsing Orders", "Extracting...");
                    addStatusLog(`Columns detected`, "success");
                    
                    const allOrders = [];
                    for (let i = 1; i < ordersData.length; i++) {
                        const row = ordersData[i];
                        if (!row || !row[colMap.orderIdCol]) continue;
                        allOrders.push({
                            orderId: String(row[colMap.orderIdCol] || "").trim(),
                            country: String(row[colMap.countryCol] || "").trim(),
                            totalWeight: parseFloat(row[colMap.weightCol]) || 0,
                            chargedCNY: parseFloat(row[colMap.cnyCostCol]) || 0,
                            chargedUSD: parseFloat(row[colMap.usdCostCol]) || 0,
                            shippingLine: String(row[colMap.shippingLineCol] || "").trim(),
                        });
                    }
                    
                    updateProgress(40, "‚úÖ Orders Parsed", `${allOrders.length} orders`);
                    addStatusLog(`‚úÖ ${allOrders.length} orders ready`, "success");
                    updateProgress(45, "‚ö° Matching Orders", "Processing...");
                    addStatusLog("‚ö° JavaScript matching (ultra fast)...");
                    
                    const results = { overcharge: [], undercharge: [], accurate: [], invalid: [] };
                    const total = allOrders.length;
                    
                    for (let i = 0; i < total; i++) {
                        const order = allOrders[i];
                        if (i % 100 === 0) {
                            const percent = 45 + (i / total) * 50;
                            updateProgress(percent, "‚ö° Processing", `${i}/${total} (${Math.round(i/total*100)}%)`);
                        }
                        
                        if (!matchShippingLine(order.shippingLine, rateData.lineName)) {
                            results.invalid.push({
                                ...order,
                                reason: `Line mismatch: ${order.shippingLine}`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }
                        
                        const countryRates = rateData.countries[order.country];
                        if (!countryRates) {
                            results.invalid.push({
                                ...order,
                                reason: `No rates for ${order.country}`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }
                        
                        const bracket = countryRates.find(b => order.totalWeight > b.minWeight && order.totalWeight <= b.maxWeight);
                        if (!bracket) {
                            results.invalid.push({
                                ...order,
                                reason: `No bracket for ${order.totalWeight}kg`,
                                expectedCNY: "N/A",
                                expectedUSD: "N/A",
                                difference: "N/A",
                                bracket: "N/A",
                            });
                            continue;
                        }
                        
                        const expectedCNY = (order.totalWeight * bracket.costPerKg) + bracket.regFee;
                        const expectedUSD = expectedCNY / exchangeRate;
                        const difference = order.chargedUSD - expectedUSD;
                        
                        const processed = {
                            ...order,
                            expectedCNY: expectedCNY.toFixed(2),
                            expectedUSD: expectedUSD.toFixed(2),
                            difference: difference.toFixed(2),
                            exchangeRate: exchangeRate,
                            bracket: bracket.details,
                        };
                        
                        if (Math.abs(difference) < 0.01) results.accurate.push(processed);
                        else if (difference > 0) results.overcharge.push(processed);
                        else results.undercharge.push(processed);
                    }
                    
                    updateProgress(100, "‚úÖ Complete!", "Done");
                    addStatusLog(`‚úÖ Overcharged: ${results.overcharge.length}`, "success");
                    addStatusLog(`‚úÖ Undercharged: ${results.undercharge.length}`, "success");
                    addStatusLog(`‚úÖ Accurate: ${results.accurate.length}`, "success");
                    addStatusLog(`‚ùå Invalid: ${results.invalid.length}`, results.invalid.length > 0 ? "error" : "success");
                    
                    setTimeout(() => {
                        document.getElementById("progressContainer").classList.add("hidden");
                        displayResults(results);
                    }, 1000);
                    
                } catch (error) {
                    showError(error.message);
                    addStatusLog(`‚ùå ${error.message}`, "error");
                } finally {
                    document.getElementById("analyzeBtn").disabled = false;
                }
            }
            
            function displayResults(results) {
                const container = document.getElementById("resultsContainer");
                container.classList.remove("hidden");
                const overchargeTotal = results.overcharge.reduce((s, o) => s + parseFloat(o.difference), 0);
                const underchargeTotal = Math.abs(results.undercharge.reduce((s, o) => s + parseFloat(o.difference), 0));
                window.resultsData = results;
                container.innerHTML = `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #fee2e2; color: #dc2626;">üìà</div>
                            <button class="download-btn" onclick="downloadCSV('overcharge')" style="background: #fee2e2; color: #dc2626;">üíæ</button>
                        </div>
                        <h3>Overcharged</h3>
                        <div class="result-amount" style="color: #dc2626;">$${overchargeTotal.toFixed(2)}</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.overcharge.length} orders</div>
                    </div>
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #d1fae5; color: #059669;">üìâ</div>
                            <button class="download-btn" onclick="downloadCSV('undercharge')" style="background: #d1fae5; color: #059669;">üíæ</button>
                        </div>
                        <h3>Undercharged</h3>
                        <div class="result-amount" style="color: #059669;">$${underchargeTotal.toFixed(2)}</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.undercharge.length} orders</div>
                    </div>
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #dbeafe; color: #2563eb;">‚úì</div>
                            <button class="download-btn" onclick="downloadCSV('accurate')" style="background: #dbeafe; color: #2563eb;">üíæ</button>
                        </div>
                        <h3>Accurate</h3>
                        <div class="result-amount" style="color: #2563eb;">100%</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">${results.accurate.length} orders</div>
                    </div>
                    <div class="result-card">
                        <div class="result-header">
                            <div class="result-icon" style="background: #f3f4f6; color: #6b7280;">‚ö†</div>
                            <button class="download-btn" onclick="downloadCSV('invalid')" style="background: #f3f4f6; color: #6b7280;">üíæ</button>
                        </div>
                        <h3>Invalid</h3>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 1rem;">${results.invalid.length} orders</div>
                    </div>
                </div>`;
            }
            
            function downloadCSV(type) {
                const data = window.resultsData[type];
                if (!data || !data.length) { alert("No data"); return; }
                const headers = ["Order ID","Country","Weight (kg)","Charged CNY","Charged USD","Expected CNY","Expected USD","Exchange Rate","Difference USD","Bracket","Shipping Line",data[0].reason?"Reason":""].filter(Boolean);
                let csv = headers.join(",") + "\n";
                let totalCNY = 0, totalUSD = 0, totalExpCNY = 0, totalExpUSD = 0, totalDiff = 0;
                data.forEach(o => {
                    csv += [o.orderId,o.country||"",o.totalWeight,o.chargedCNY,o.chargedUSD,o.expectedCNY,o.expectedUSD,o.exchangeRate||"",o.difference,`"${o.bracket}"`,o.shippingLine,o.reason||""].filter((_,i)=>i<headers.length).join(",")+"\n";
                    if(o.expectedCNY!=="N/A"){totalCNY+=parseFloat(o.chargedCNY);totalUSD+=parseFloat(o.chargedUSD);totalExpCNY+=parseFloat(o.expectedCNY);totalExpUSD+=parseFloat(o.expectedUSD);totalDiff+=parseFloat(o.difference);}
                });
                csv+="\n"+["TOTAL","","",totalCNY.toFixed(2),totalUSD.toFixed(2),totalExpCNY.toFixed(2),totalExpUSD.toFixed(2),"",totalDiff.toFixed(2),"","",""].slice(0,headers.length).join(",");
                const a=document.createElement("a");
                a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
                a.download=`${type}_orders.csv`;
                a.click();
            }
        </script>
    </body>
</html>
